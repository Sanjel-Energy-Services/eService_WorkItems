## 1. Program请求提交与分配流程

```mermaid
sequenceDiagram
participant S as 销售/调度
participant FS as PRM应用
participant E as 工程师
participant EM as 工程经理

S->>FS: 提交Program请求(邮件/表单)
alt 单Program请求
		FS->>FS: 创建单个 ProgramRequest
else 多Program请求
		FS->>FS: 创建多个 ProgramRequest (同一提交)
		FS->>FS: 关联请求组 (Group ID)???
end
alt 公司有映射工程师
		FS->>E: 自动分配给对应工程师(所有Program)
		FS->>E: 自动触发工作流发送分配通知(批量)
else 公司无映射工程师
		FS->>EM: 分配给工程经理(所有Program)
		EM->>E: 手动分配请求(可分配给不同工程师)
		FS->>E: 自动触发工作流发送分配通知
end
E->>FS: 确认接收请求
FS->>FS: 更新状态为"Received/Assigned"
FS->>S: 推送进度更新（已分配）
```

## 2. Program审查与批准流程

```mermaid
sequenceDiagram
participant E as 工程师
participant FS as PRM应用
participant E1 as 同级工程师
participant M as 经理
participant D as 总监/副总裁
participant S as 销售/调度
participant O as 运营团队

E->>FS: 完成Program草稿并提交审查
FS->>FS: 更新状态为"Sent for Review"
alt 绿色矩阵(同级审查)
		E->>FS: 手动分配给同级工程师或Peer Review组
		alt 分配给特定人员
				FS->>E1: 发送审查通知(包含SharePoint链接+应用链接)
		else 分配给Peer Review组
				FS->>Peer Review组: 发送组通知(首个接受者处理)
		end
		E1->>FS: 审查结果(通过/拒绝+评论)
else 黄色矩阵(经理审查)
		E->>FS: 手动分配给经理/主管
		FS->>M: 发送审查通知(包含SharePoint链接+应用链接)
		M->>FS: 审查结果(通过/拒绝+评论)
else 红色矩阵(经理批准)
		FS->>FS: 自动路由给经理批准
		FS->>M: 发送批准通知(包含SharePoint链接+应用链接)
		M->>FS: 批准结果(通过/拒绝+评论)
else 黑色矩阵(多级批准)
		FS->>FS: 自动路由给经理→总监/VP串行批准
		FS->>M: 发送经理批准通知
		M->>FS: 经理批准结果
		FS->>D: 发送总监/VP最终批准通知
		D->>FS: 最终批准结果(通过/拒绝+评论)
end

alt 审批通过
		FS->>E: 通知审批结果
		FS->>S: 通知销售/调度审批完成（提供Program文档链接/SharePoint外链）
		FS->>O: 通知运营团队可下载（提供Program文档链接/SharePoint外链）
else 审批拒绝
		FS->>E: 退回修改并附评论
		E->>FS: 重新提交修订版本
end
```

## 3. 多作业类型审批流程

```mermaid
sequenceDiagram
participant E as 工程师
participant FS as PRM应用
participant PR as 同级工程师
participant M as 经理/主管
participant D as 总监/VP

E->>FS: 提交包含多个作业类型的Program
FS->>FS: 分析各作业类型的矩阵颜色
alt MVP阶段实现
	FS->>FS: 确定最高权限审批路径(基于最严格矩阵颜色)
	alt 最高权限为绿色矩阵
		E->>PR: 分配给同级工程师
		PR->>FS: 一次性审批决定(通过/拒绝+评论)
	else 最高权限为黄色矩阵
		E->>M: 分配给经理/主管
		M->>FS: 一次性审批决定(通过/拒绝+评论)
	else 最高权限为红色矩阵
		FS->>M: 自动路由给经理批准
		M->>FS: 一次性批准决定(通过/拒绝+评论)
	else 最高权限为黑色矩阵
		FS->>M: 自动路由给经理批准
		M->>FS: 经理批准
		FS->>D: 自动路由给总监/VP最终批准
		D->>FS: 最终批准决定(通过/拒绝+评论)
	end
	alt 审批通过
		FS->>E: 通知整个Program已批准
		FS->>FS: 标记Program为"已批准"
		FS->>FS: 通知销售/调度可访问(SharePoint链接)
		FS->>FS: 通知运营团队可下载(SharePoint链接)
	else 审批拒绝
		FS->>E: 退回修改并附评论(整个Program)
		E->>FS: 重新提交修订版本
	end
else 未来扩展实现
	FS->>FS: 为每个作业类型创建独立审批记录
	par 作业类型A(绿色→同级审查)
		E->>PR: 手动分配给同级工程师
		PR->>FS: 审查结果A(通过/拒绝+评论)
	and 作业类型B(黄色→经理审查)
		E->>M: 手动分配给经理/主管
		M->>FS: 审查结果B(通过/拒绝+评论)
	and 作业类型C(红色→经理批准)
		FS->>M: 自动路由给经理批准
		M->>FS: 批准结果C(通过/拒绝+评论)
	and 作业类型D(黑色→经理+总监批准)
		FS->>M: 自动路由给经理批准
		M->>FS: 经理批准
		FS->>D: 自动路由给总监/VP最终批准
		D->>FS: 最终批准结果D
	end
	
	FS->>FS: 汇总所有作业类型审批结果
	alt 全部通过
		FS->>E: 通知完全批准
		FS->>FS: 标记Program为"已批准"
		FS->>FS: 通知销售/调度可访问(SharePoint链接)
		FS->>FS: 通知运营团队可下载(SharePoint链接)
	else 部分拒绝
		FS->>E: 通知部分拒绝详情(具体作业类型)
		FS->>FS: 仅退回被拒绝的作业类型
		E->>FS: 重新提交被拒绝的作业类型修订版本
	end
end
```

## 4. 搜索与报告生成流程

```mermaid
sequenceDiagram
participant U as 用户
participant FS as PRM应用
participant DB as 数据库

U->>FS: 输入搜索条件(客户/日期/矩阵颜色等)
FS->>DB: 执行搜索查询
DB->>FS: 返回搜索结果
FS->>U: 显示搜索结果(<3秒响应)

U->>FS: 请求生成分析报告
FS->>DB: 聚合数据(周转时间/分布等)
DB->>FS: 返回聚合数据
FS->>FS: 生成可视化报告
FS->>U: 显示报告图表和指标
```

这些序列图涵盖了文档中描述的主要业务流程，包括：
- 请求提交和自动分配（支持单Program/多Program请求）
- 基于复杂度矩阵的多级审批
- 多作业类型的并行审批
- 全生命周期状态跟踪
- 搜索和报告功能

## 6. 生命周期状态一致性补充

为与FRD定义的状态集保持一致，系统用例涉及的显式或隐式状态如下：

| FRD状态 | 用例中体现的动作/备注 | 说明 |
|---------|------------------------|------|
| Open | 提交Program请求 | 请求首次进入系统 |
| Received | 请求已接收 (提示) | 系统记录并进入接收阶段 |
| Unacknowledged | 发送分配通知 | 已指派但工程师未确认（隐含） |
| Acknowledged | 工程师确认接收 | 工程师主动确认分配 |
| Pending | 等待开始/分配细化 | 无明确操作时的过渡（隐含） |
| In Progress | 草稿进行中 | 工程师起草Program |
| Sent for Review | 提交审查 | 触发评审通知 |
| Awaiting Review | 审查通知已发送 | 等待评审者处理 |
| Reviewed | 审查通过/拒绝 | 评审结束并产生结果 |
| Sent for Approval | (黄色/红色/黑色路径触发审批) | 已进入审批通知阶段 |
| Awaiting Approval | 经理/总监审批等待 | 等待最终决策输入 |
| Approved | 审批通过 | Program被批准 |
| Sent to Sales / Awaiting Pricing | 通知销售可访问最终Program | 销售/定价处理前置状态 |
| Completed | 上传最终文档并归档 | 生命周期闭合 |

> 注：用例文本中未显式出现的辅助过渡状态（Unacknowledged, Pending, Sent for Approval 等）在序列图外通过系统自动动作存在。

## 7. 多作业类型审批 (MVP说明)

当前实现 (MVP)：当一个Program包含多个作业类型且各自矩阵颜色不同时，由最高权限审批者基于最严格的矩阵颜色一次性批准整个Program，避免多次串行等待。审批包含：
- 邮件通知（包含SharePoint文档链接和应用链接）
- 工作流内通知（支持接受/拒绝操作界面）
- 审批记录（时间、结果、评论）
- 拒绝时自动退回工程师修订

未来扩展：每个作业类型独立记录审批步骤、结果与评论；部分拒绝时仅需重新提交被拒绝作业类型，其他保持通过状态。

## 8. 优先级与SLA补充

| 优先级 | FRD定义条件 | 用例触发点 | SLA示例 (参考) |
|--------|-------------|------------|----------------|
| Urgent | 距到期 < 4 小时 | 自动分类和优先级排序 | 响应 < 15 分钟，处理加速 |
| High | 当天到期 | 自动分类 | 首次响应 < 30 分钟 |
| Medium | 2 天内到期 | 自动分类 | 正常队列 |
| Low | >2 天 | 自动分类 | 延后处理 |

## 9. 审批路径精确描述

| 矩阵颜色 | 用例动作 | 角色 | 性质 | 通知方式 |
|----------|----------|------|------|----------|
| Green | 工程师手动分配给同级工程师审查 | 同级工程师 | 评审 (Peer Review) | 邮件+工作流内通知 |
| Yellow | 工程师手动分配给经理/主管审查 | 经理/主管 | 评审 (Manager Review) | 邮件+工作流内通知 |
| Red | 系统路由给经理批准 | 经理 | 最终批准 | 邮件+工作流内通知 |
| Black | 系统路由给经理→总监/VP最终批准 | 经理 + 总监/VP | 串行多级最终批准 | 邮件+工作流内通知 |

**通知内容要求：**
- SharePoint文档链接（可点击）
- 应用内操作链接（接受/拒绝+评论）
- 请求详情（ID、客户、服务线）
- 审查截止日期

## 10. 分类与报告补充

分类(Classification)：Bid / Price Quote / Awarded Work；在“Program请求提交与分配流程”阶段记录，用于后续转换率与周转报告。

报告扩展指标：
- 各矩阵颜色分布
- 审批平均耗时(分层：Peer/Manager/Director)
- 重提交率 (Reject 后重新提交次数)
- 分类转换率 (Bid→Awarded Work)
- 多Program请求完成率(同一提交内所有Program完成比例)
- 批量分配效率(单次分配处理的Program数量)

## 11. 集成工作流协作用例

### 11.1 工作流通知发送流程

```mermaid
sequenceDiagram
	participant WFE as 工作流引擎
	participant NS as 通知服务
	participant ES as 邮件服务
	participant DB as 数据库
	participant FS as PRM应用
	
	WFE->>FS: 触发工作流事件(分配/审查/批准等)
	FS->>DB: 查询接收者信息
	DB->>FS: 返回接收者详情
	FS->>NS: 创建通知任务
	NS->>NS: 生成通知内容(包含SharePoint链接+应用链接)
	NS->>ES: 发送邮件通知
	NS->>FS: 创建工作流内通知
	ES->>ES: 跟踪邮件发送状态
	ES->>NS: 返回发送结果
	NS->>DB: 记录通知状态和时间戳
	NS->>WFE: 通知发送完成确认
```

### 11.2 状态转换工作流流程

```mermaid
sequenceDiagram
	participant Actor as 业务参与者
	participant WFE as 工作流引擎
	participant FS as PRM应用
	participant StateManager as 状态管理器
	participant DB as 数据库
	participant NS as 通知服务
	
	Actor->>FS: 执行业务动作(提交/审查/批准/拒绝等)
	FS->>WFE: 触发状态转换事件
	WFE->>StateManager: 验证状态转换规则
	StateManager->>DB: 获取当前状态
	DB->>StateManager: 返回状态信息
	StateManager->>StateManager: 检查转换权限和条件
	alt 转换有效
		StateManager->>DB: 更新状态
		StateManager->>FS: 状态更新成功
		FS->>NS: 触发状态变更通知
		NS->>NS: 发送相关方通知
		FS->>Actor: 返回操作成功结果
	else 转换无效
		StateManager->>FS: 状态转换失败
		FS->>Actor: 返回错误信息
	end
```

### 11.3 批量工作流处理流程

```mermaid
sequenceDiagram
	participant WFE as 工作流引擎
	participant BatchProcessor as 批量处理器
	participant NS as 通知服务
	participant DB as 数据库
	participant FS as PRM应用
	
	WFE->>BatchProcessor: 触发批量工作流(多Program分配/通知)
	BatchProcessor->>DB: 查询批量处理任务列表
	DB->>BatchProcessor: 返回任务集合
	par 并行处理多个Program
		BatchProcessor->>FS: 处理Program A
		FS->>NS: 创建通知A
	and 并行处理多个Program
		BatchProcessor->>FS: 处理Program B
		FS->>NS: 创建通知B
	and 并行处理多个Program
		BatchProcessor->>FS: 处理Program C
		FS->>NS: 创建通知C
	end
	BatchProcessor->>BatchProcessor: 汇总处理结果
	BatchProcessor->>DB: 批量更新状态
	BatchProcessor->>WFE: 批量处理完成报告
```

### 11.4 工作流异常处理与重试机制

```mermaid
sequenceDiagram
	participant WFE as 工作流引擎
	participant ES as 邮件服务
	participant RetryManager as 重试管理器
	participant DB as 数据库
	participant AlertSystem as 告警系统
	
	WFE->>ES: 发送工作流通知
	ES->>ES: 通知发送失败
	ES->>WFE: 返回失败状态
	WFE->>RetryManager: 触发重试机制
	RetryManager->>RetryManager: 检查重试次数限制
	alt 未达到重试上限
		RetryManager->>ES: 重新发送通知
		ES->>WFE: 返回重试结果
		RetryManager->>DB: 记录重试日志
	else 达到重试上限
		RetryManager->>AlertSystem: 触发告警
		AlertSystem->>AlertSystem: 发送系统管理员通知
		RetryManager->>DB: 记录失败状态和告警信息
		RetryManager->>WFE: 标记工作流异常
	end
```

### 11.5 工作流监控与性能统计

```mermaid
sequenceDiagram
	participant Monitor as 监控系统
	participant WFE as 工作流引擎
	participant Metrics as 指标收集器
	participant DB as 数据库
	participant Dashboard as 监控面板
	
	Monitor->>WFE: 定期检查工作流状态
	WFE->>Metrics: 收集性能指标
	Metrics->>DB: 查询工作流执行数据
	DB->>Metrics: 返回统计信息
	Metrics->>Metrics: 计算关键指标(KPI)
	alt 性能正常
		Metrics->>Dashboard: 更新正常状态显示
	else 性能异常
		Metrics->>Dashboard: 显示警告状态
		Dashboard->>Dashboard: 触发性能优化建议
	end
	Monitor->>DB: 存储监控快照
	Monitor->>Dashboard: 更新实时监控面板
```

### 11.6 工作流配置管理

```mermaid
sequenceDiagram
	participant Admin as 系统管理员
	participant WFConfig as 工作流配置
	participant WFE as 工作流引擎
	participant DB as 数据库
	participant Validator as 配置验证器
	
	Admin->>WFConfig: 修改工作流配置(通知模板/状态规则/重试策略)
	WFConfig->>Validator: 验证配置有效性
	Validator->>Validator: 检查配置语法和逻辑
	alt 配置有效
		Validator->>WFConfig: 验证通过
		WFConfig->>DB: 保存新配置
		DB->>WFConfig: 确认保存
		WFConfig->>WFE: 通知配置更新
		WFE->>WFE: 重新加载工作流配置
		WFConfig->>Admin: 返回配置成功
	else 配置无效
		Validator->>WFConfig: 返回验证错误
		WFConfig->>Admin: 显示错误信息和建议
		Admin->>WFConfig: 修正配置
	end
```

### 11.7 ProgramRequest自动分配工作流

```mermaid
sequenceDiagram
    participant S as 销售/调度
    participant WFE as 工作流引擎
    participant CompanyMapper as 公司映射器
    participant DB as 数据库
    participant E as 工程师
    participant EM as 工程经理
    participant NS as 通知服务
    
    S->>WFE: 提交Program请求(邮件/表单)
    WFE->>DB: 创建ProgramRequest记录
    WFE->>CompanyMapper: 查询公司-工程师映射
    CompanyMapper->>DB: 检查公司映射表
    DB->>CompanyMapper: 返回映射结果
    alt 公司有映射工程师
        CompanyMapper->>WFE: 返回指定工程师
        WFE->>DB: 更新ProgramRequest状态为"Assigned"
        WFE->>NS: 触发分配通知给工程师
        NS->>E: 发送邮件通知(包含应用链接)
        NS->>E: 发送工作流内通知
        WFE->>S: 推送进度更新(已分配)
    else 公司无映射工程师
        CompanyMapper->>WFE: 无映射信息
        WFE->>DB: 更新ProgramRequest状态为"Unassigned"
        WFE->>NS: 触发分配通知给工程经理
        NS->>EM: 发送邮件通知(需要手动分配)
        NS->>EM: 发送工作流内通知
    end
    WFE->>DB: 记录分配日志和时间戳
```

### 11.8 ProgramJob自动分配工作流

```mermaid
sequenceDiagram
    participant E as 工程师
    participant WFE as 工作流引擎
    participant JobAnalyzer as 作业分析器
    participant ComplexityMatrix as 复杂度矩阵
    participant DB as 数据库
    participant PR as 同级工程师
    participant M as 经理/主管
    participant D as 总监/VP
    participant NS as 通知服务
    
    E->>WFE: 提交包含多个ProgramJob的Program
    WFE->>JobAnalyzer: 分析ProgramJob集合
    JobAnalyzer->>ComplexityMatrix: 查询每个Job的复杂度颜色
    ComplexityMatrix->>DB: 获取Job类型复杂度映射
    DB->>ComplexityMatrix: 返回复杂度规则
    ComplexityMatrix->>JobAnalyzer: 返回各Job的矩阵颜色
    JobAnalyzer->>WFE: 返回分析结果(最高权限级别)
    
    alt MVP实现 - 统一分配
        WFE->>WFE: 确定最高权限审批路径
        alt 最高权限为绿色(同级审查)
            WFE->>E: 提示手动分配同级工程师
            E->>WFE: 指定同级工程师
            WFE->>NS: 触发同级审查通知
            NS->>PR: 发送审查通知(SharePoint链接+应用链接)
        else 最高权限为黄色(经理审查)
            WFE->>E: 提示手动分配经理/主管
            E->>WFE: 指定经理/主管
            WFE->>NS: 触发经理审查通知
            NS->>M: 发送审查通知(SharePoint链接+应用链接)
        else 最高权限为红色(经理批准)
            WFE->>NS: 自动触发经理批准通知
            NS->>M: 发送批准通知(SharePoint链接+应用链接)
        else 最高权限为黑色(多级批准)
            WFE->>NS: 自动触发经理批准通知
            NS->>M: 发送经理批准通知
            M->>WFE: 经理批准后
            WFE->>NS: 触发总监/VP最终批准通知
            NS->>D: 发送最终批准通知(SharePoint链接+应用链接)
        end
    else 未来扩展实现 - 独立分配
        WFE->>WFE: 为每个Job创建独立审批路径
        par Job A(绿色)处理
            WFE->>NS: 触发同级审查通知
            NS->>PR: 发送Job A审查通知
        and Job B(黄色)处理
            WFE->>NS: 触发经理审查通知
            NS->>M: 发送Job B审查通知
        and Job C(红色)处理
            WFE->>NS: 触发经理批准通知
            NS->>M: 发送Job C批准通知
        end
    end
    WFE->>DB: 记录Job分配日志和状态
```
