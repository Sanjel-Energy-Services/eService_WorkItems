# 6 åˆ›å»ºå’Œç»´æŠ¤é¢†åŸŸæ¨¡å‹ï¼ˆä¸šåŠ¡å»ºæ¨¡ï¼‰

## 6.1 é¢†åŸŸæ¨¡å‹çš„æ¦‚å¿µä¸ä»·å€¼

### 6.1.1 ä»€ä¹ˆæ˜¯é¢†åŸŸæ¨¡å‹

é¢†åŸŸæ¨¡å‹æ˜¯ä¸šåŠ¡æ¦‚å¿µå’Œè§„åˆ™åœ¨è½¯ä»¶ç³»ç»Ÿä¸­çš„**æ¨¡å¼åŒ–æŠ½è±¡è¡¨ç¤º**ï¼Œå®ƒé€šè¿‡çŠ¶æ€æ¨¡å¼å’Œå·¥ä½œæµæ¨¡å¼ç²¾ç¡®æè¿°ä¸šåŠ¡å®ä½“ã€ä¸šåŠ¡è§„åˆ™å’Œä¸šåŠ¡æµç¨‹ï¼Œæ˜¯è¿æ¥ä¸šåŠ¡éœ€æ±‚ä¸æŠ€æœ¯å®ç°çš„æ¡¥æ¢ã€‚

### 6.1.2 æ¨¡å¼åŒ–é¢†åŸŸæ¨¡å‹çš„æ ¸å¿ƒä»·å€¼

```mermaid
flowchart LR
    A[ğŸ¯ ä¸šåŠ¡éœ€æ±‚] --> B[ğŸ—ï¸ æ¨¡å¼åŒ–é¢†åŸŸæ¨¡å‹]
    B --> C[ğŸ”„ çŠ¶æ€æ¨¡å¼åº”ç”¨]
    B --> D[ğŸŒŠ ä¸šåŠ¡æµæ¨¡å¼åº”ç”¨]
    
    C --> C1[è¡Œä¸ºçŠ¶æ€æ¨¡å¼]
    C --> C2[ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æ¨¡å¼]
    C --> C3[ç»“æ„çŠ¶æ€æ¨¡å¼]
    C --> C4[äº‹ä»¶æº¯æºçŠ¶æ€æ¨¡å¼]
    C --> C5[æ­£äº¤çŠ¶æ€æ¨¡å¼]
    
    D --> D1[çŠ¶æ€æœºé©±åŠ¨æµ]
    D --> D2[äº‹ä»¶é£æš´é©±åŠ¨æµ]
    D --> D3[ä¸šåŠ¡æµç¨‹é©±åŠ¨æµ]
    D --> D4[å†³ç­–è¡¨é©±åŠ¨æµ]
    D --> D5[åä½œé©±åŠ¨æµ]
    D --> D6[è®¡åˆ’-æ‰§è¡Œé©±åŠ¨æµ]
    D --> D7[æ•°æ®ç®¡é“é©±åŠ¨æµ]
    D --> D8[åå•†é©±åŠ¨æµ]
    
    B --> E[ğŸ’» æŠ€æœ¯å®ç°]
    B --> F[ğŸ¨ ç”¨æˆ·ç•Œé¢]
    B --> G[ğŸ“Š æ•°æ®æ¨¡å‹]
    
    H[ğŸ”„ éœ€æ±‚å˜æ›´] --> B
    B --> I[ğŸ“ æ¨¡å¼åŒ–æ–‡æ¡£è¾“å‡º]

    classDef pattern fill:#e3f2fd,stroke:#1565c0
    classDef tech fill:#e8f5e9,stroke:#2e7d32
    
    class C1,C2,C3,C4,C5,D1,D2,D3,D4,D5,D6,D7,D8 pattern
    class E,F,G tech
```

**æ¨¡å¼åŒ–ç»Ÿä¸€è¯­è¨€**ï¼šä¸ºä¸šåŠ¡äººå‘˜å’ŒæŠ€æœ¯äººå‘˜æä¾›åŸºäºæ¨¡å¼çš„å…±åŒæ²Ÿé€šåŸºç¡€
**ä¸šåŠ¡é€»è¾‘æ¨¡å¼åŒ–**ï¼šé€šè¿‡çŠ¶æ€æ¨¡å¼å’Œä¸šåŠ¡æµæ¨¡å¼ç³»ç»ŸåŒ–ç»„ç»‡ä¸šåŠ¡è§„åˆ™
**æ¶æ„æŒ‡å¯¼æ€§**ï¼šæ¨¡å¼é€‰æ‹©ç›´æ¥å½±å“ç³»ç»Ÿæ¶æ„ã€æ•°æ®åº“è®¾è®¡å’ŒAPIè®¾è®¡
**å˜æ›´å¯é¢„æµ‹æ€§**ï¼šä¸šåŠ¡å˜åŒ–æ—¶èƒ½å¤ŸåŸºäºæ¨¡å¼å¿«é€Ÿå®šä½å½±å“èŒƒå›´å’Œä¿®æ”¹ç­–ç•¥

## 6.2 æ¨¡å¼é©±åŠ¨çš„é¢†åŸŸæ¨¡å‹æ„å»ºæ–¹æ³•è®º

### 6.2.1 æ ¸å¿ƒå»ºæ¨¡åŸåˆ™

**åŸåˆ™1ï¼šå‚ä¸è€…å®šä¹‰ç³»ç»Ÿè¾¹ç•Œ**

- åªæœ‰**ç›´æ¥ä¸ç³»ç»Ÿäº¤äº’**çš„ä¸šåŠ¡å‚ä¸è€…ï¼ˆ`Â«businessActorÂ»`ï¼‰å’Œå‚ä¸è€…ï¼ˆ`Â«actorÂ»`ï¼‰æ‰å‡ºç°åœ¨æ¨¡å‹ä¸­
- å‚ä¸è€…ä»£è¡¨äº†ç³»ç»Ÿçš„è¾¹ç•Œï¼Œæ‰€æœ‰åŠŸèƒ½å¿…é¡»æœåŠ¡äºå‚ä¸è€…çš„éœ€æ±‚

**åŸåˆ™2ï¼šæ¨¡å¼ä¼˜å…ˆçš„è®¾è®¡æ€ç»´**
- åœ¨å»ºæ¨¡æ—©æœŸå°±è¯†åˆ«å¹¶åº”ç”¨**çŠ¶æ€æ¨¡å¼äº”ç»´åº¦**å’Œ**ä¸šåŠ¡æµå…«æ¨¡å¼**
- è¿™äº›æ¨¡å¼ç›´æ¥å½±å“ç•Œé¢åŸå‹ã€ç”¨ä¾‹åˆ†æå’ŒæŠ€æœ¯å®ç°ç­–ç•¥

**åŸåˆ™3ï¼šä»·å€¼é©±åŠ¨çš„å†…å®¹ç­›é€‰**
- ä»»ä½•å®ä½“çš„**å±æ€§**æˆ–**æ–¹æ³•**å¿…é¡»ç›´æ¥æˆ–é—´æ¥æœåŠ¡äºå‚ä¸è€…äº¤äº’
- æ¯ä¸ªæ¨¡å‹å…ƒç´ éƒ½åº”èƒ½è¿½æº¯åˆ°å…·ä½“çš„å‚ä¸è€…éœ€æ±‚å’Œä¸šåŠ¡ä»·å€¼

**åŸåˆ™4ï¼šäº¤äº’æ–¹å¼å†³å®šå®ç°ç­–ç•¥**
- å‚ä¸è€…ä¸å®ä½“ç±»çš„äº¤äº’æ–¹å¼ç”±å‚ä¸è€…ç±»å‹å†³å®šï¼š
  - **äººå‘˜å‚ä¸è€…** â†’ é€šè¿‡**ç”¨æˆ·ç•Œé¢**äº¤äº’
  - **å¤–éƒ¨ç³»ç»Ÿå‚ä¸è€…** â†’ é€šè¿‡**APIæ¥å£**äº¤äº’

**åŸåˆ™5ï¼šåˆ†å±‚æŠ½è±¡çš„æ–‡æ¡£ç­–ç•¥**
- **ç³»ç»Ÿçº§æ–‡æ¡£**ï¼šæè¿°å‚ä¸è€…å’Œæ ¸å¿ƒæ¨¡å¼å…³ç³»
- **ç”¨ä¾‹çº§æ–‡æ¡£**ï¼šåœ¨å…·ä½“æ¨¡å¼å®ç°ä¸­æè¿°ç›¸å…³å±æ€§å’Œæ–¹æ³•

### 6.2.2 æ¨¡å¼é©±åŠ¨çš„æ„å»ºæµç¨‹

```mermaid
flowchart TD
    A[ğŸ“‹ éœ€æ±‚åˆ†æ] --> B[ğŸ‘¥ è¯†åˆ«ç›´æ¥äº¤äº’çš„å‚ä¸è€…]
    B --> B1[Â«businessActorÂ»<br>å¤–éƒ¨ä¸šåŠ¡å‚ä¸è€…]
    B --> B2[Â«actorÂ»<br>å†…éƒ¨è§’è‰²ä¸å¤–éƒ¨ç³»ç»Ÿ]
    
    B1 & B2 --> C[ğŸ¯ çŠ¶æ€æ¨¡å¼ç»´åº¦é€‰æ‹©]
    C --> C1[è¡Œä¸ºçŠ¶æ€æ¨¡å¼]
    C --> C2[ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æ¨¡å¼]
    C --> C3[ç»“æ„çŠ¶æ€æ¨¡å¼]
    C --> C4[äº‹ä»¶æº¯æºçŠ¶æ€æ¨¡å¼]
    C --> C5[æ­£äº¤çŠ¶æ€æ¨¡å¼]
    
    B1 & B2 --> D[ğŸŒŠ ä¸šåŠ¡æµæ¨¡å¼é€‰æ‹©]
    D --> D1[çŠ¶æ€æœºé©±åŠ¨æµ]
    D --> D2[äº‹ä»¶é£æš´é©±åŠ¨æµ]
    D --> D3[ä¸šåŠ¡æµç¨‹é©±åŠ¨æµ]
    D --> D4[å…¶ä»–ä¸šåŠ¡æµæ¨¡å¼]
    
    C1 & D1 --> E[ğŸ—ï¸ æ¨¡å¼åŒ–é¢†åŸŸç±»è®¾è®¡]
    E --> F[ğŸ”„ å»ºç«‹æ¨¡å¼å…³è”å…³ç³»]
    F --> G[âœ… æ¨¡å¼ä¸€è‡´æ€§éªŒè¯]
    G --> G1[çŠ¶æ€æ¨¡å¼ä¸ä¸šåŠ¡æµæ¨¡å¼ä¸€è‡´?]
    G1 -->|æ˜¯| H[ğŸ“ ç³»ç»Ÿçº§æ¨¡å¼æ–‡æ¡£åŒ–]
    G1 -->|å¦| I[ğŸ”„ æ¨¡å¼è°ƒæ•´]
    
    subgraph H [ç³»ç»Ÿçº§æ¨¡å¼æ–‡æ¡£]
        H1[å‚ä¸è€…ä¸æ¨¡å¼è¾¹ç•Œ]
        H2[çŠ¶æ€æ¨¡å¼æ¶æ„]
        H3[ä¸šåŠ¡æµæ¨¡å¼åä½œ]
        H4[æ¨¡å¼äº¤äº’è§„èŒƒ]
    end

    classDef statePattern fill:#e3f2fd,stroke:#1565c0
    classDef flowPattern fill:#fff3e0,stroke:#ff6f00
    classDef validation fill:#e8f5e9,stroke:#2e7d32
    
    class C1,C2,C3,C4,C5 statePattern
    class D1,D2,D3,D4 flowPattern
    class G validation
```

## 6.3 è®¢å•ç³»ç»Ÿé¢†åŸŸæ¨¡å‹æ„å»ºå®ä¾‹

### 6.3.1 å‚ä¸è€…è¯†åˆ«ä¸æ¨¡å¼æ˜ å°„

```mermaid
classDiagram
    direction TB
    
    class Customer {
        <<businessActor>>
        +customerId: String
        +name: String
        +placeOrder() Order
        +confirmReceipt() void
    }
    
    class CustomerService {
        <<actor>>
        +staffId: String
        +handleComplaint() void
        +modifyOrder() void
    }
    
    class WarehouseOperator {
        <<actor>>
        +operatorId: String
        +checkInventory() void
        +processShipping() void
    }
    
    class PaymentGateway {
        <<actor>>
        +gatewayId: String
        +processPayment() void
        +refundPayment() void
    }
    
    class LogisticsSystem {
        <<actor>>
        +systemId: String
        +trackShipment() void
        +updateDelivery() void
    }
    
    %% æ¨¡å¼æ˜ å°„å…³ç³»
    Customer --> OrderLifecycleState : çŠ¶æ€æœºé©±åŠ¨æµ
    CustomerService --> OrderBehaviorState : è¡Œä¸ºçŠ¶æ€æ¨¡å¼
    WarehouseOperator --> InventoryStructuralState : ç»“æ„çŠ¶æ€æ¨¡å¼
    PaymentGateway --> PaymentEventSourcedState : äº‹ä»¶æº¯æºçŠ¶æ€æ¨¡å¼
    LogisticsSystem --> OrderOrthogonalState : æ­£äº¤çŠ¶æ€æ¨¡å¼
```

### 6.3.2 äº”ç»´åº¦çŠ¶æ€æ¨¡å¼ç³»ç»ŸåŒ–åº”ç”¨

#### è®¢å•ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æ¨¡å¼ï¼ˆLifecycle Stateï¼‰

```mermaid
classDiagram
    direction TB
    
    class Order {
        -orderId: String
        -totalAmount: BigDecimal
        -currentState: OrderLifecycleState
        +submit() void
        +pay() void
        +ship() void
        +complete() void
        +cancel() void
    }
    
    class OrderLifecycleState {
        <<lifecycleState>>
        +canPay() Boolean
        +canShip() Boolean
        +canComplete() Boolean
        +validateTransition(targetState: OrderLifecycleState) Boolean
    }
    
    class ShoppingCartState {
        <<state>>
        +submit(order: Order) void
        +cancel(order: Order) void
    }
    
    class PendingPaymentState {
        <<state>>
        +pay(order: Order) void
        +cancel(order: Order) void
    }
    
    class PaidState {
        <<state>>
        +ship(order: Order) void
        +requestRefund(order: Order) void
    }
    
    class ShippedState {
        <<state>>
        +confirmDelivery(order: Order) void
        +reportIssue(order: Order) void
    }
    
    class CompletedState {
        <<state>>
        +archive(order: Order) void
    }
    
    class CancelledState {
        <<state>>
        +onEntry(order: Order) void
    }
    
    Order *--> "1" OrderLifecycleState
    OrderLifecycleState <|-- ShoppingCartState
    OrderLifecycleState <|-- PendingPaymentState
    OrderLifecycleState <|-- PaidState
    OrderLifecycleState <|-- ShippedState
    OrderLifecycleState <|-- CompletedState
    OrderLifecycleState <|-- CancelledState
```

**çŠ¶æ€è½¬æ¢å›¾**ï¼š
```mermaid
stateDiagram-v2
    [*] --> ShoppingCartState
    ShoppingCartState --> PendingPaymentState : submit()
    ShoppingCartState --> CancelledState : cancel()
    
    PendingPaymentState --> PaidState : pay()
    PendingPaymentState --> CancelledState : cancel()
    
    PaidState --> ShippedState : ship()
    PaidState --> CancelledState : requestRefund()
    
    ShippedState --> CompletedState : confirmDelivery()
    ShippedState --> CancelledState : reportIssue()
    
    CompletedState --> [*]
    CancelledState --> [*]
```

#### æ”¯ä»˜è¡Œä¸ºçŠ¶æ€æ¨¡å¼ï¼ˆBehavior Stateï¼‰

```mermaid
classDiagram
    direction LR
    
    class Payment {
        -paymentId: String
        -amount: BigDecimal
        -currentState: PaymentBehaviorState
        +initiatePayment() void
        +confirmPayment() void
        +refund() void
        +cancel() void
    }
    
    class PaymentBehaviorState {
        <<behaviorState>>
        +canProcess() Boolean
        +canRefund() Boolean
        +canCancel() Boolean
    }
    
    class PendingState {
        <<state>>
        +initiatePayment(payment: Payment) void
        +cancel(payment: Payment) void
    }
    
    class ProcessingState {
        <<state>>
        +confirmPayment(payment: Payment) void
        +failPayment(payment: Payment) void
    }
    
    class CompletedState {
        <<state>>
        +refund(payment: Payment) void
    }
    
    class FailedState {
        <<state>>
        +retryPayment(payment: Payment) void
    }
    
    class RefundedState {
        <<state>>
        +onEntry(payment: Payment) void
    }
    
    Payment *--> "1" PaymentBehaviorState
    PaymentBehaviorState <|-- PendingState
    PaymentBehaviorState <|-- ProcessingState
    PaymentBehaviorState <|-- CompletedState
    PaymentBehaviorState <|-- FailedState
    PaymentBehaviorState <|-- RefundedState
```

#### åº“å­˜ç»“æ„çŠ¶æ€æ¨¡å¼ï¼ˆStructural Stateï¼‰

```mermaid
classDiagram
    direction LR
    
    class Inventory {
        -inventoryId: String
        -productId: String
        -currentState: InventoryStructuralState
        +lockStock() void
        +releaseStock() void
        +updateStock() void
    }
    
    class InventoryStructuralState {
        <<structuralState>>
        +canLock() Boolean
        +canRelease() Boolean
        +canUpdate() Boolean
        +getAvailableComponents() List~Component~
    }
    
    class AvailableState {
        <<state>>
        +lockStock(inventory: Inventory) void
    }
    
    class LockedState {
        <<state>>
        +releaseStock(inventory: Inventory) void
        +updateStock(inventory: Inventory) void
    }
    
    class OutOfStockState {
        <<state>>
        +updateStock(inventory: Inventory) void
    }
    
    class DiscontinuedState {
        <<state>>
        +onEntry(inventory: Inventory) void
    }
    
    Inventory *--> "1" InventoryStructuralState
    InventoryStructuralState <|-- AvailableState
    InventoryStructuralState <|-- LockedState
    InventoryStructuralState <|-- OutOfStockState
    InventoryStructuralState <|-- DiscontinuedState
```

#### æ”¯ä»˜äº‹ä»¶æº¯æºçŠ¶æ€æ¨¡å¼ï¼ˆEvent Sourced Stateï¼‰

```mermaid
classDiagram
    direction LR
    
    class PaymentEventSourcedState {
        <<eventSourcedState>>
        +paymentId: String
        +balance: BigDecimal
        +status: PaymentStatus
        +apply(event: PaymentEvent) void
        +reconstruct(events: List~PaymentEvent~) PaymentEventSourcedState
        +getTransactionHistory() List~Transaction~
    }
    
    class Payment {
        -paymentId: String
        -currentState: PaymentEventSourcedState
        -version: Long
        +processPayment() void
        +refundPayment() void
        +replayEvents(events: List~PaymentEvent~) void
    }
    
    class PaymentEvent {
        <<event>>
        -paymentId: String
        -timestamp: DateTime
        +getType() String
    }
    
    class PaymentCreatedEvent {
        <<event>>
        -amount: BigDecimal
        -paymentMethod: String
    }
    
    class PaymentProcessedEvent {
        <<event>>
        -transactionId: String
        -processedAmount: BigDecimal
    }
    
    class PaymentRefundedEvent {
        <<event>>
        -refundAmount: BigDecimal
        -refundReason: String
    }
    
    Payment *--> "1" PaymentEventSourcedState
    PaymentEventSourcedState --> "*" PaymentEvent : sources from
    PaymentEvent <|-- PaymentCreatedEvent
    PaymentEvent <|-- PaymentProcessedEvent
    PaymentEvent <|-- PaymentRefundedEvent
```

#### è®¢å•æ­£äº¤çŠ¶æ€æ¨¡å¼ï¼ˆOrthogonal Stateï¼‰

```mermaid
classDiagram
    direction LR
    
    class OrderOrthogonalState {
        <<orthogonalState>>
        +orderStatus: OrderStatusState
        +paymentStatus: PaymentStatusState
        +inventoryStatus: InventoryStatusState
        +logisticsStatus: LogisticsStatusState
        +handleEvent(event: OrderEvent) Set~StateTransition~
        +isValidCombination() Boolean
    }
    
    class OrderStatusState {
        <<stateDimension>>
        +handleOrderEvent(event: OrderEvent) StateTransition
    }
    
    class PaymentStatusState {
        <<stateDimension>>
        +handlePaymentEvent(event: PaymentEvent) StateTransition
    }
    
    class InventoryStatusState {
        <<stateDimension>>
        +handleInventoryEvent(event: InventoryEvent) StateTransition
    }
    
    class LogisticsStatusState {
        <<stateDimension>>
        +handleLogisticsEvent(event: LogisticsEvent) StateTransition
    }
    
    %% è®¢å•çŠ¶æ€ç»´åº¦
    class DraftState {
        <<state>>
        +handleOrderEvent(event: OrderEvent) StateTransition
    }
    
    class ConfirmedState {
        <<state>>
        +handleOrderEvent(event: OrderEvent) StateTransition
    }
    
    class FulfilledState {
        <<state>>
        +handleOrderEvent(event: OrderEvent) StateTransition
    }
    
    %% æ”¯ä»˜çŠ¶æ€ç»´åº¦
    class UnpaidState {
        <<state>>
        +handlePaymentEvent(event: PaymentEvent) StateTransition
    }
    
    class PaidState {
        <<state>>
        +handlePaymentEvent(event: PaymentEvent) StateTransition
    }
    
    class RefundedState {
        <<state>>
        +handlePaymentEvent(event: PaymentEvent) StateTransition
    }
    
    OrderOrthogonalState *--> "1" OrderStatusState
    OrderOrthogonalState *--> "1" PaymentStatusState
    OrderOrthogonalState *--> "1" InventoryStatusState
    OrderOrthogonalState *--> "1" LogisticsStatusState
    
    OrderStatusState <|-- DraftState
    OrderStatusState <|-- ConfirmedState
    OrderStatusState <|-- FulfilledState
    
    PaymentStatusState <|-- UnpaidState
    PaymentStatusState <|-- PaidState
    PaymentStatusState <|-- RefundedState
```

### 6.3.3 ä¸šåŠ¡æµæ¨¡å¼ç³»ç»ŸåŒ–åº”ç”¨

#### çŠ¶æ€æœºé©±åŠ¨æµï¼ˆState Machine Driven Flowï¼‰

```mermaid
sequenceDiagram
    participant C as Customer<br>Â«businessActorÂ»
    participant OM as OrderManager<br>Â«actorÂ»
    participant WS as WarehouseOperator<br>Â«actorÂ»
    participant O as Order
    participant OS as OrderLifecycleState
    
    Note over C,OS: ä¸‹å•æµç¨‹
    C->>O: placeOrder()
    O->>OS: new ShoppingCartState()
    
    C->>O: submit()
    O->>OS: canTransitionTo(PendingPaymentState)
    OS-->>O: true
    O->>OS: transitionTo(PendingPaymentState)
    
    C->>O: pay()
    O->>OS: transitionTo(PaidState)
    O->>WS: notifyShippingRequired()
    
    WS->>O: ship()
    O->>OS: transitionTo(ShippedState)
    O->>C: notifyShipped()
    
    C->>O: confirmReceipt()
    O->>OS: transitionTo(CompletedState)
```

#### äº‹ä»¶é£æš´é©±åŠ¨æµï¼ˆEvent Storming Driven Flowï¼‰

```mermaid
sequenceDiagram
    participant C as Customer<br>Â«businessActorÂ»
    participant PS as PaymentService<br>Â«actorÂ»
    participant IS as InventoryService<br>Â«actorÂ»
    participant O as Order
    participant ES as OrderEventSourcedState
    participant EH as EventHandler
    
    C->>O: placeOrder()
    O->>ES: apply(OrderCreatedEvent)
    ES->>EH: publish(OrderCreatedEvent)
    EH->>IS: reserveInventory()
    
    C->>O: pay()
    O->>ES: apply(OrderPaidEvent)
    ES->>EH: publish(OrderPaidEvent)
    EH->>IS: confirmInventoryReservation()
    EH->>PS: processPayment()
    
    PS->>O: paymentProcessed()
    O->>ES: apply(PaymentProcessedEvent)
    ES->>EH: publish(OrderReadyForFulfillment)
```

#### ä¸šåŠ¡æµç¨‹é©±åŠ¨æµï¼ˆBusiness Process Driven Flowï¼‰

```mermaid
flowchart TD
    A[ğŸ“ è®¢å•æäº¤] --> B[ğŸ”„ åº“å­˜é¢„ç•™]
    B --> C[ğŸ’³ æ”¯ä»˜å¤„ç†]
    C --> D{æ”¯ä»˜æˆåŠŸ?}
    D -->|æ˜¯| E[ğŸ“¦ è®¢å•å±¥çº¦]
    D -->|å¦| F[âŒ è®¢å•å–æ¶ˆ]
    E --> G[ğŸšš å‘è´§å¤„ç†]
    G --> H[âœ… è®¢å•å®Œæˆ]
    F --> I[ğŸ”„ åº“å­˜é‡Šæ”¾]
    
    J[âš ï¸ å¼‚å¸¸å¤„ç†] --> K[â¸ï¸ æµç¨‹æš‚åœ]
    K --> L[ğŸ”§ äººå·¥å¹²é¢„]
    L --> M[â–¶ï¸ æµç¨‹æ¢å¤]
    M --> C
```

#### å†³ç­–è¡¨é©±åŠ¨æµï¼ˆDecision Table Driven Flowï¼‰

**å®šä»·å†³ç­–è¡¨ç¤ºä¾‹**ï¼š

| å®¢æˆ·ç­‰çº§ | è®¢å•é‡‘é¢ | ä¿ƒé”€æ´»åŠ¨ | æœ€ç»ˆæŠ˜æ‰£ |
| -------- | -------- | -------- | -------- |
| VIP      | â‰¥1000    | åŒåä¸€   | 25%      |
| VIP      | â‰¥1000    | æ—        | 15%      |
| æ™®é€š     | â‰¥1000    | åŒåä¸€   | 20%      |
| æ™®é€š     | â‰¥1000    | æ—        | 10%      |
| ä»»ä½•     | <1000    | åŒåä¸€   | 15%      |
| ä»»ä½•     | <1000    | æ—        | 5%       |

### 6.3.4 æ¨¡å¼ç»„åˆåº”ç”¨ç¤ºä¾‹

#### å¤æ‚è®¢å•å¤„ç†ï¼šå¤šæ¨¡å¼ååŒ

```mermaid
sequenceDiagram
    participant C as Customer<br>Â«businessActorÂ»
    participant PS as PaymentSystem<br>Â«actorÂ»
    participant IS as InventorySystem<br>Â«actorÂ»
    participant LS as LogisticsSystem<br>Â«actorÂ»
    participant O as Order
    participant OS as OrderOrthogonalState
    participant PES as PaymentEventSourcedState
    
    Note over C,LS: å¤šæ¨¡å¼ååŒè®¢å•å¤„ç†
    C->>O: placeOrder()
    O->>OS: handleEvent(OrderCreated)
    OS->>OS: orderStatusâ†’Draft, paymentStatusâ†’Unpaid
    
    C->>O: submitOrder()
    O->>OS: handleEvent(OrderSubmitted)
    OS->>IS: checkInventory()
    IS-->>O: inventoryReserved
    OS->>OS: inventoryStatusâ†’Reserved
    
    C->>O: pay()
    O->>PES: apply(PaymentCreatedEvent)
    PES->>PS: processPayment()
    PS-->>PES: paymentProcessed
    PES->>PES: apply(PaymentProcessedEvent)
    PES->>OS: handleEvent(PaymentCompleted)
    OS->>OS: paymentStatusâ†’Paid
    
    OS->>LS: scheduleShipping()
    LS-->>O: shippingScheduled
    OS->>OS: logisticsStatusâ†’Scheduled
```

## 6.4 é¢†åŸŸæ¨¡å‹ç»´æŠ¤ä¸æ¼”è¿›

### 6.4.1 æ¨¡å¼é©±åŠ¨çš„éœ€æ±‚å˜æ›´å¤„ç†

```mermaid
flowchart TD
    A[ğŸ“ æ–°éœ€æ±‚/å˜æ›´è¯·æ±‚] --> B[ğŸ” æ¨¡å¼å½±å“åˆ†æ]
    B --> C{æ¶‰åŠçš„æ¨¡å¼ç±»å‹}
    
    C -->|çŠ¶æ€æ¨¡å¼| D[ğŸ”„ çŠ¶æ€æ¨¡å¼æ‰©å±•]
    C -->|ä¸šåŠ¡æµæ¨¡å¼| E[ğŸŒŠ ä¸šåŠ¡æµæ¨¡å¼è°ƒæ•´]
    C -->|æ¨¡å¼ç»„åˆ| F[ğŸ”€ æ¨¡å¼ç»„åˆä¼˜åŒ–]
    
    D --> D1[è¡Œä¸ºçŠ¶æ€æ‰©å±•]
    D --> D2[ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è°ƒæ•´]
    D --> D3[ç»“æ„çŠ¶æ€å˜æ›´]
    D --> D4[äº‹ä»¶æº¯æºå¢å¼º]
    D --> D5[æ­£äº¤çŠ¶æ€æ‰©å±•]
    
    E --> E1[çŠ¶æ€æœºæµç¨‹è°ƒæ•´]
    E --> E2[äº‹ä»¶æµä¼˜åŒ–]
    E --> E3[ä¸šåŠ¡æµç¨‹é‡æ„]
    E --> E4[å†³ç­–è¡¨æ›´æ–°]
    
    F --> G[âœ… æ¨¡å¼ä¸€è‡´æ€§éªŒè¯]
    G --> H[ğŸ“ æ¨¡å¼æ–‡æ¡£åŒæ­¥]
    
    subgraph H [æ–‡æ¡£åŒæ­¥]
        H1[çŠ¶æ€æ¨¡å¼æ–‡æ¡£]
        H2[ä¸šåŠ¡æµæ¨¡å¼æ–‡æ¡£]
        H3[æ¨¡å¼äº¤äº’è§„èŒƒ]
        H4[APIæ¥å£æ›´æ–°]
    end
    
    H --> I[ğŸ”„ å›¢é˜Ÿæ¨¡å¼è¯„å®¡]
    I --> J[âœ… å˜æ›´å®Œæˆ]

    classDef statePattern fill:#e3f2fd,stroke:#1565c0
    classDef flowPattern fill:#fff3e0,stroke:#ff6f00
    
    class D1,D2,D3,D4,D5 statePattern
    class E1,E2,E3,E4 flowPattern
```

### 6.4.2 å¤æ‚å˜æ›´ç¤ºä¾‹ï¼šä¼˜æƒ åˆ¸ç³»ç»Ÿï¼ˆå¤šæ¨¡å¼ç»„åˆï¼‰

#### é¢†åŸŸæ¨¡å‹æ›´æ–°

```mermaid
classDiagram
    direction LR

    class Order {
        -orderId: String
        -totalAmount: BigDecimal
        -discountAmount: BigDecimal
        -finalAmount: BigDecimal
        +applyCoupon(coupon: Coupon) void
        +calculateFinalAmount() BigDecimal
        +removeCoupon() void
    }

    class Coupon {
        -couponId: String
        -code: String
        -discountType: DiscountType
        -discountValue: BigDecimal
        -currentState: CouponLifecycleState
        -behaviorState: CouponBehaviorState
        -eventState: CouponEventSourcedState
        +validate() Boolean
        +applyTo(order: Order) void
        +markAsUsed() void
        +expire() void
    }

    class CouponLifecycleState {
        <<lifecycleState>>
        +canApply() Boolean
        +canExpire() Boolean
        +canUse() Boolean
    }
    
    class CouponBehaviorState {
        <<behaviorState>>
        +calculateDiscount(order: Order) BigDecimal
        +validateConditions(order: Order) Boolean
    }
    
    class CouponEventSourcedState {
        <<eventSourcedState>>
        +apply(event: CouponEvent) void
        +getUsageHistory() List~CouponEvent~
    }

    class PromotionCampaign {
        -campaignId: String
        -name: String
        -orthogonalState: CampaignOrthogonalState
        +createCoupons() List~Coupon~
        +distributeCoupons() void
        +endCampaign() void
    }
    
    class CampaignOrthogonalState {
        <<orthogonalState>>
        +status: CampaignStatusState
        +distribution: DistributionState
        +performance: PerformanceState
    }

    Order "1" -- "*" Coupon : uses
    Coupon *--> "1" CouponLifecycleState
    Coupon *--> "1" CouponBehaviorState
    Coupon *--> "1" CouponEventSourcedState
    PromotionCampaign "1" o-- "*" Coupon : generates
    PromotionCampaign *--> "1" CampaignOrthogonalState
```

#### å¤šæ¨¡å¼ååŒä¸šåŠ¡æµç¨‹

```mermaid
sequenceDiagram
    participant C as Customer<br>Â«businessActorÂ»
    participant MS as MarketingSystem<br>Â«actorÂ»
    participant O as Order
    participant CP as Coupon
    participant CLS as CouponLifecycleState
    participant CBS as CouponBehaviorState
    participant CES as CouponEventSourcedState
    
    Note over C,MS: å¤šæ¨¡å¼ä¼˜æƒ åˆ¸ä½¿ç”¨æµç¨‹
    C->>O: applyCoupon(couponCode)
    O->>CP: validate()
    CP->>CLS: canApply()
    CLS-->>CP: true
    CP->>CBS: validateConditions(O)
    CBS-->>CP: validationResult
    
    alt éªŒè¯é€šè¿‡
        CP->>CBS: calculateDiscount(O)
        CBS-->>CP: discountAmount
        CP->>CES: apply(CouponUsedEvent)
        CES->>MS: recordCouponUsage()
        CP->>CLS: markAsUsed()
        O->>C: ä¼˜æƒ åˆ¸åº”ç”¨æˆåŠŸ
    else éªŒè¯å¤±è´¥
        CP->>CES: apply(CouponValidationFailedEvent)
        O->>C: ä¼˜æƒ åˆ¸ä¸å¯ç”¨
    end
```

## 6.5 æ¨¡å¼éªŒè¯ä¸è´¨é‡ä¿è¯

### 6.5.1 æ¨¡å¼ä¸€è‡´æ€§æ£€æŸ¥æ¸…å•

- [ ] **çŠ¶æ€æ¨¡å¼å®Œæ•´æ€§**ï¼šæ‰€æœ‰ä¸šåŠ¡çŠ¶æ€æ˜¯å¦éƒ½æœ‰å¯¹åº”çš„çŠ¶æ€æ¨¡å¼è¦†ç›–
- [ ] **ä¸šåŠ¡æµåè°ƒæ€§**ï¼šä¸šåŠ¡æµæ¨¡å¼æ˜¯å¦ä¸çŠ¶æ€æ¨¡å¼åè°ƒä¸€è‡´
- [ ] **æ¨¡å¼è¾¹ç•Œæ¸…æ™°**ï¼šå„æ¨¡å¼èŒè´£è¾¹ç•Œæ˜¯å¦æ¸…æ™°ï¼Œæ— é‡å å†²çª
- [ ] **å‚ä¸è€…å¯¹é½**ï¼šæ‰€æœ‰æ¨¡å¼æ˜¯å¦éƒ½æœåŠ¡äºå·²è¯†åˆ«çš„å‚ä¸è€…
- [ ] **å˜æ›´å¯è¿½æº¯**ï¼šä¸šåŠ¡å˜æ›´æ˜¯å¦èƒ½è¿½æº¯åˆ°å…·ä½“çš„æ¨¡å¼è°ƒæ•´

### 6.5.2 äº”ç»´åº¦çŠ¶æ€æ¨¡å¼é€‰æ‹©æŒ‡å—

```mermaid
flowchart TD
    Start[çŠ¶æ€æ¨¡å¼é€‰æ‹©] --> Q1{éœ€è¦ç®¡ç†å¤šä¸ªç‹¬ç«‹çŠ¶æ€ç»´åº¦?}
    
    Q1 -->|æ˜¯| Orthogonal[æ­£äº¤çŠ¶æ€æ¨¡å¼<br>æ±½è½¦æ§åˆ¶ç³»ç»Ÿ/å¤æ‚è®¢å•çŠ¶æ€]
    Q1 -->|å¦| Q2{éœ€è¦å®Œæ•´çš„å†å²è¿½æº¯èƒ½åŠ›?}
    
    Q2 -->|æ˜¯| EventSourced[äº‹ä»¶æº¯æºçŠ¶æ€æ¨¡å¼<br>æ”¯ä»˜äº¤æ˜“/å®¡è®¡ç³»ç»Ÿ]
    Q2 -->|å¦| Q3{çŠ¶æ€å½±å“å¯¹è±¡å†…éƒ¨ç»“æ„?}
    
    Q3 -->|æ˜¯| Structural[ç»“æ„çŠ¶æ€æ¨¡å¼<br>ä¿é™©ä¿å•/å¤æ‚äº§å“é…ç½®]
    Q3 -->|å¦| Q4{çŠ¶æ€è½¬æ¢æœ‰ä¸¥æ ¼é¡ºåº?}
    
    Q4 -->|æ˜¯| Lifecycle[ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æ¨¡å¼<br>è®¢å•æµç¨‹/å®¡æ‰¹æµç¨‹]
    Q4 -->|å¦| Behavioral[è¡Œä¸ºçŠ¶æ€æ¨¡å¼<br>UIäº¤äº’/æ”¯ä»˜å¤„ç†]
```

### 6.5.3 ä¸šåŠ¡æµæ¨¡å¼é€‰æ‹©æŒ‡å—

```mermaid
flowchart TD
    Start[ä¸šåŠ¡æµæ¨¡å¼é€‰æ‹©] --> Q1{æµç¨‹æœ‰æ˜ç¡®çŠ¶æ€è½¬æ¢?}
    
    Q1 -->|æ˜¯| StateMachine[çŠ¶æ€æœºé©±åŠ¨æµ<br>è®¢å•å¤„ç†/å®¡æ‰¹å·¥ä½œæµ]
    Q1 -->|å¦| Q2{éœ€è¦äº‹ä»¶è¿½æº¯å’Œé‡æ”¾?}
    
    Q2 -->|æ˜¯| EventStorming[äº‹ä»¶é£æš´é©±åŠ¨æµ<br>ä¿é™©å¤„ç†/äº¤æ˜“ç³»ç»Ÿ]
    Q2 -->|å¦| Q3{æµç¨‹æ­¥éª¤å›ºå®šä¸”æœ‰ä¾èµ–?}
    
    Q3 -->|æ˜¯| BusinessProcess[ä¸šåŠ¡æµç¨‹é©±åŠ¨æµ<br>è´·æ¬¾å®¡æ‰¹/åˆè§„å®¡æŸ¥]
    Q3 -->|å¦| Q4{åŸºäºå¤æ‚è§„åˆ™å†³ç­–?}
    
    Q4 -->|æ˜¯| DecisionTable[å†³ç­–è¡¨é©±åŠ¨æµ<br>ç†èµ”è¯„ä¼°/ä¿¡ç”¨é£é™©]
    Q4 -->|å¦| Q5{éœ€è¦å¤šæ–¹åä½œ?}
    
    Q5 -->|æ˜¯| Collaboration[åä½œé©±åŠ¨æµ<br>åŒ»ç–—å›¢é˜Ÿ/é¡¹ç›®å›¢é˜Ÿ]
    Q5 -->|å¦| Q6{æŒ‰è®¡åˆ’åˆ†æ­¥æ‰§è¡Œ?}
    
    Q6 -->|æ˜¯| PlanExecute[è®¡åˆ’-æ‰§è¡Œé©±åŠ¨æµ<br>é¡¹ç›®ç®¡ç†/ç”Ÿäº§è®¡åˆ’]
    Q6 -->|å¦| Q7{æ•°æ®å¤„ç†ç®¡é“?}
    
    Q7 -->|æ˜¯| DataPipeline[æ•°æ®ç®¡é“é©±åŠ¨æµ<br>ETLå¤„ç†/æŠ¥è¡¨ç”Ÿæˆ]
    Q7 -->|å¦| Negotiation[åå•†é©±åŠ¨æµ<br>åˆåŒè°ˆåˆ¤/äº‰è®®è§£å†³]
```

### 6.5.4 æ¨¡å¼ç»„åˆéªŒè¯è§„åˆ™

**æœ‰æ•ˆæ¨¡å¼ç»„åˆç¤ºä¾‹**ï¼š
```yaml
OrderProcessing:
  state_patterns:
    - lifecycle: è®¢å•ç”Ÿå‘½å‘¨æœŸ
    - event_sourced: æ”¯ä»˜äº‹ä»¶æº¯æº
    - orthogonal: å¤šç»´åº¦çŠ¶æ€
  flow_patterns:
    - state_machine: çŠ¶æ€æœºé©±åŠ¨
    - event_storming: äº‹ä»¶é©±åŠ¨

CampaignManagement:
  state_patterns:
    - behavioral: ä¼˜æƒ åˆ¸è¡Œä¸º
    - structural: æ´»åŠ¨ç»“æ„
  flow_patterns:
    - business_process: æµç¨‹é©±åŠ¨
    - decision_table: è§„åˆ™å†³ç­–
```

**æ— æ•ˆæ¨¡å¼ç»„åˆè­¦ç¤º**ï¼š
```yaml
AntiPatterns:
  - äº‹ä»¶æº¯æºçŠ¶æ€ + ç®€å•ä¸šåŠ¡æµç¨‹: "è¿‡åº¦å¤æ‚"
  - æ­£äº¤çŠ¶æ€ + å•ä¸€ä¸šåŠ¡æµ: "è®¾è®¡è¿‡åº¦"
  - è¡Œä¸ºçŠ¶æ€ + å¤æ‚åä½œæµ: "æ¨¡å¼ä¸åŒ¹é…"
```

## 6.6 å›¢é˜Ÿåä½œä¸æ¨¡å¼æ²»ç†

### 6.6.1 æ¨¡å¼è¯„å®¡æµç¨‹

**å››å±‚è¯„å®¡æœºåˆ¶**ï¼š
1. **ä¸šåŠ¡æ¨¡å¼è¯„å®¡**ï¼šä¸šåŠ¡ä¸“å®¶éªŒè¯æ¨¡å¼ä¸šåŠ¡å‡†ç¡®æ€§
2. **æŠ€æœ¯æ¨¡å¼è¯„å®¡**ï¼šæ¶æ„å¸ˆéªŒè¯æ¨¡å¼æŠ€æœ¯å¯è¡Œæ€§
3. **å®ç°æ¨¡å¼è¯„å®¡**ï¼šå¼€å‘å›¢é˜ŸéªŒè¯æ¨¡å¼å®ç°å¤æ‚åº¦
4. **æµ‹è¯•æ¨¡å¼è¯„å®¡**ï¼šæµ‹è¯•å›¢é˜ŸéªŒè¯æ¨¡å¼å¯æµ‹è¯•æ€§

### 6.6.2 æ¨¡å¼æ–‡æ¡£è§„èŒƒ

**æ¨¡å¼æ–‡æ¡£ç»“æ„**ï¼š
```markdown
# [æ¨¡å¼åç§°] æ–‡æ¡£è§„èŒƒ

## æ¨¡å¼ç±»å‹
- çŠ¶æ€æ¨¡å¼: [è¡Œä¸º/ç”Ÿå‘½å‘¨æœŸ/ç»“æ„/äº‹ä»¶æº¯æº/æ­£äº¤]
- ä¸šåŠ¡æµæ¨¡å¼: [å…«ç§æ¨¡å¼ä¹‹ä¸€]

## ä¸šåŠ¡åœºæ™¯
- é€‚ç”¨ä¸šåŠ¡åœºæ™¯æè¿°
- è§£å†³çš„é—®é¢˜åŸŸ

## æ¨¡å¼ç»“æ„
- ç±»å›¾å±•ç¤º
- çŠ¶æ€è½¬æ¢å›¾
- åºåˆ—å›¾ç¤ºä¾‹

## å®æ–½æŒ‡å—
- å®æ–½æ­¥éª¤
- æ³¨æ„äº‹é¡¹
- å¸¸è§é—®é¢˜
```

### 6.6.3 æ¨¡å¼æ¼”è¿›ç®¡ç†

**æ¨¡å¼ç‰ˆæœ¬æ§åˆ¶**ï¼š
- ä½¿ç”¨Gitè¿›è¡Œæ¨¡å¼å®šä¹‰ç‰ˆæœ¬æ§åˆ¶
- æ¯æ¬¡æ¨¡å¼å˜æ›´æäº¤è¯¦ç»†çš„æ¼”è¿›è¯´æ˜
- ç»´æŠ¤æ¨¡å¼æ¼”è¿›å†å²å’Œä½¿ç”¨ç»Ÿè®¡

## 6.7 æ€»ç»“

é€šè¿‡ç³»ç»ŸåŒ–çš„çŠ¶æ€æ¨¡å¼äº”ç»´åº¦å’Œä¸šåŠ¡æµå…«æ¨¡å¼çš„åº”ç”¨ï¼Œé¢†åŸŸæ¨¡å‹ä»ç®€å•çš„ä¸šåŠ¡æ¦‚å¿µæŠ½è±¡å‡çº§ä¸º**æ¨¡å¼é©±åŠ¨çš„ä¸šåŠ¡æ¶æ„è“å›¾**ã€‚

**å…³é”®æˆåŠŸå› ç´ **ï¼š

1. **æ¨¡å¼æ€ç»´åŸ¹å…»**ï¼šå›¢é˜Ÿå»ºç«‹æ¨¡å¼é©±åŠ¨çš„è®¾è®¡å’Œæ²Ÿé€šæ–¹å¼
2. **æ¨¡å¼æ°å½“é€‰æ‹©**ï¼šæ ¹æ®ä¸šåŠ¡å¤æ‚åº¦é€‰æ‹©åˆé€‚çš„çŠ¶æ€å’Œæµç¨‹æ¨¡å¼
3. **æ¨¡å¼ç»„åˆè‰ºæœ¯**ï¼šæŒæ¡å¤šæ¨¡å¼ååŒè®¾è®¡çš„æŠ€å·§å’ŒåŸåˆ™
4. **æŒç»­æ¨¡å¼æ¼”è¿›**ï¼šå»ºç«‹è§„èŒƒçš„æ¨¡å¼å˜æ›´å’Œæ–‡æ¡£åŒæ­¥æœºåˆ¶

**ä»·å€¼ä½“ç°**ï¼š

- **å¼€å‘æ•ˆç‡**ï¼šæ¨¡å¼å¤ç”¨å‡å°‘é‡å¤è®¾è®¡å·¥ä½œ
- **ç³»ç»Ÿè´¨é‡**ï¼šæ¨¡å¼åŒ–è®¾è®¡æé«˜ç³»ç»Ÿå¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§
- **å›¢é˜Ÿåä½œ**ï¼šç»Ÿä¸€æ¨¡å¼è¯­è¨€æ”¹å–„è·¨è§’è‰²æ²Ÿé€šæ•ˆç‡
- **ä¸šåŠ¡å“åº”**ï¼šæ¨¡å¼åŒ–æ¶æ„æ”¯æŒå¿«é€Ÿä¸šåŠ¡å˜åŒ–å“åº”

é€šè¿‡æœ¬ç« çš„ç³»ç»ŸåŒ–æ–¹æ³•è®ºå’Œå®è·µæ¡ˆä¾‹ï¼Œå›¢é˜Ÿå¯ä»¥å»ºç«‹é«˜æ•ˆçš„**æ¨¡å¼é©±åŠ¨é¢†åŸŸå»ºæ¨¡**èƒ½åŠ›ï¼Œä¸ºæ„å»ºé«˜è´¨é‡ã€å¯æ¼”è¿›çš„è½¯ä»¶ç³»ç»Ÿå¥ å®šåšå®åŸºç¡€ã€‚

# 6.7 è®¢å•ç³»ç»Ÿé¢†åŸŸæ¨¡å‹æ¦‚è§ˆ

## 6.7.1 é¢†åŸŸæ¨¡å‹æ¦‚è§ˆå›¾

```mermaid
classDiagram
    direction TB
    
    %% ç¬¬ä¸€æ­¥ï¼šè¯†åˆ«å‚ä¸è€…ï¼ˆè“è‰²ï¼‰
    class Customer {
        <<businessActor>>
    }
    
    class OrderManager {
        <<actor>>
    }
    
    class WarehouseOperator {
        <<actor>>
    }
    
    class PaymentGateway {
        <<actor>>
    }
    
    class LogisticsSystem {
        <<actor>>
    }
    
    %% ç¬¬äºŒæ­¥ï¼šè¯†åˆ«èšåˆæ ¹ï¼ˆç»¿è‰²ï¼‰
    class Order {
        <<aggregate root>>
    }
    
    class Product {
        <<aggregate root>>
    }
    
    %% ç¬¬ä¸‰æ­¥ï¼šè¯†åˆ«æ ¸å¿ƒå®ä½“ï¼ˆé»„è‰²ï¼‰
    class OrderItem {
        <<entity>>
    }
    
    class Payment {
        <<entity>>
    }
    
    class ShoppingCart {
        <<entity>>
    }
    
    class Inventory {
        <<entity>>
    }
    
    %% ç¬¬å››æ­¥ï¼šè¯†åˆ«çŠ¶æ€æ¨¡å¼ï¼ˆæ©™è‰²ï¼‰
    class OrderLifecycleState {
        <<lifecycleState>>
    }
    
    class ShoppingCartState {
        <<state>>
    }
    
    class PendingPaymentState {
        <<state>>
    }
    
    class PaidState {
        <<state>>
    }
    
    class ShippedState {
        <<state>>
    }
    
    class CompletedState {
        <<state>>
    }
    
    class CancelledState {
        <<state>>
    }
    
    class PaymentBehaviorState {
        <<behaviorState>>
    }
    
    class PendingPayment {
        <<state>>
    }
    
    class ProcessingPayment {
        <<state>>
    }
    
    class CompletedPayment {
        <<state>>
    }
    
    class FailedPayment {
        <<state>>
    }
    
    class InventoryStructuralState {
        <<structuralState>>
    }
    
    class AvailableState {
        <<state>>
    }
    
    class LockedState {
        <<state>>
    }
    
    class OutOfStockState {
        <<state>>
    }
    
    %% ç¬¬äº”æ­¥ï¼šå»ºç«‹å…³è”å…³ç³»
    Customer "1" *-- "*" Order : places
    Order "1" *-- "*" OrderItem : contains
    OrderItem "*" --> "1" Product : references
    Order "1" -- "0..1" Payment : has
    Customer "1" -- "1" ShoppingCart : owns
    ShoppingCart --> "*" Product : includes
    Product "1" -- "1" Inventory : manages
    
    %% çŠ¶æ€æ¨¡å¼å…³ç³»
    Order *--> "1" OrderLifecycleState
    OrderLifecycleState <|-- ShoppingCartState
    OrderLifecycleState <|-- PendingPaymentState
    OrderLifecycleState <|-- PaidState
    OrderLifecycleState <|-- ShippedState
    OrderLifecycleState <|-- CompletedState
    OrderLifecycleState <|-- CancelledState
    
    Payment *--> "1" PaymentBehaviorState
    PaymentBehaviorState <|-- PendingPayment
    PaymentBehaviorState <|-- ProcessingPayment
    PaymentBehaviorState <|-- CompletedPayment
    PaymentBehaviorState <|-- FailedPayment
    
    Inventory *--> "1" InventoryStructuralState
    InventoryStructuralState <|-- AvailableState
    InventoryStructuralState <|-- LockedState
    InventoryStructuralState <|-- OutOfStockState
    
    %% å‚ä¸è€…ä¸é¢†åŸŸç±»äº¤äº’
    OrderManager ..> Order : manages
    WarehouseOperator ..> Order : fulfills
    PaymentGateway ..> Payment : processes
    LogisticsSystem ..> Order : tracks

    %% æ ·å¼å®šä¹‰ - æŒ‰é¢œè‰²åˆ†ç±»
    style Customer fill:#a6c1ff,stroke:#333,stroke-width:2px
    style OrderManager fill:#a6c1ff,stroke:#333,stroke-width:2px
    style WarehouseOperator fill:#a6c1ff,stroke:#333,stroke-width:2px
    style PaymentGateway fill:#a6c1ff,stroke:#333,stroke-width:2px
    style LogisticsSystem fill:#a6c1ff,stroke:#333,stroke-width:2px
    
    style Order fill:#a8e6a1,stroke:#333,stroke-width:2px
    style Product fill:#a8e6a1,stroke:#333,stroke-width:2px
    
    style OrderItem fill:#fff9a8,stroke:#333,stroke-width:2px
    style Payment fill:#fff9a8,stroke:#333,stroke-width:2px
    style ShoppingCart fill:#fff9a8,stroke:#333,stroke-width:2px
    style Inventory fill:#fff9a8,stroke:#333,stroke-width:2px
    
    style OrderLifecycleState fill:#ffd8a6,stroke:#333,stroke-width:2px
    style ShoppingCartState fill:#ffd8a6,stroke:#333,stroke-width:2px
    style PendingPaymentState fill:#ffd8a6,stroke:#333,stroke-width:2px
    style PaidState fill:#ffd8a6,stroke:#333,stroke-width:2px
    style ShippedState fill:#ffd8a6,stroke:#333,stroke-width:2px
    style CompletedState fill:#ffd8a6,stroke:#333,stroke-width:2px
    style CancelledState fill:#ffd8a6,stroke:#333,stroke-width:2px
    style PaymentBehaviorState fill:#ffd8a6,stroke:#333,stroke-width:2px
    style PendingPayment fill:#ffd8a6,stroke:#333,stroke-width:2px
    style ProcessingPayment fill:#ffd8a6,stroke:#333,stroke-width:2px
    style CompletedPayment fill:#ffd8a6,stroke:#333,stroke-width:2px
    style FailedPayment fill:#ffd8a6,stroke:#333,stroke-width:2px
    style InventoryStructuralState fill:#ffd8a6,stroke:#333,stroke-width:2px
    style AvailableState fill:#ffd8a6,stroke:#333,stroke-width:2px
    style LockedState fill:#ffd8a6,stroke:#333,stroke-width:2px
    style OutOfStockState fill:#ffd8a6,stroke:#333,stroke-width:2px
```

## 6.7.2 æ¦‚è§ˆå›¾åˆ¶ä½œåŸåˆ™ä¸æ­¥éª¤

### åˆ¶ä½œåŸåˆ™

1. **å‚ä¸è€…ä¼˜å…ˆåŸåˆ™**
   - é¦–å…ˆè¯†åˆ«æ‰€æœ‰ä¸šåŠ¡å‚ä¸è€…å’Œç³»ç»Ÿå‚ä¸è€…
   - æ˜ç¡®åŒºåˆ† `Â«businessActorÂ»` å’Œ `Â«actorÂ»` çš„èŒè´£è¾¹ç•Œ

2. **èšåˆæ ¹æ ‡è¯†åŸåˆ™**
   - æ˜ç¡®æ ‡è¯†èšåˆæ ¹ï¼Œç¡®ä¿ä¸šåŠ¡å®Œæ•´æ€§è¾¹ç•Œ
   - èšåˆæ ¹è´Ÿè´£ç»´æŠ¤å†…éƒ¨å®ä½“çš„ä¸šåŠ¡è§„åˆ™

3. **çŠ¶æ€æ¨¡å¼æ˜¾å¼åŒ–åŸåˆ™**
   - å°†çŠ¶æ€æ¨¡å¼ä½œä¸ºä¸€ç­‰å…¬æ°‘åœ¨æ¨¡å‹ä¸­æ˜¾å¼å±•ç¤º
   - æ˜ç¡®çŠ¶æ€ç±»ä¸é¢†åŸŸç±»çš„å…³ç³»

4. **å…³ç³»æœ€å°åŒ–åŸåˆ™**
   - åªå±•ç¤ºæ ¸å¿ƒçš„ä¸šåŠ¡å…³ç³»
   - é¿å…è¿‡åº¦å¤æ‚çš„å…³è”å…³ç³»

5. **åˆ†å±‚å±•ç¤ºåŸåˆ™**
   - å‚ä¸è€…å±‚ã€é¢†åŸŸç±»å±‚ã€çŠ¶æ€æ¨¡å¼å±‚æ¸…æ™°åˆ†ç¦»
   - ä½¿ç”¨æ–¹å‘æ§åˆ¶é˜…è¯»æµ

### åˆ¶ä½œæ­¥éª¤

```mermaid
flowchart TD
    A[ç¬¬ä¸€æ­¥: è¯†åˆ«å‚ä¸è€…] --> B[ç¬¬äºŒæ­¥: è¯†åˆ«èšåˆæ ¹]
    B --> C[ç¬¬ä¸‰æ­¥: è¯†åˆ«æ ¸å¿ƒå®ä½“]
    C --> D[ç¬¬å››æ­¥: è¯†åˆ«çŠ¶æ€æ¨¡å¼]
    D --> E[ç¬¬äº”æ­¥: å»ºç«‹å…³è”å…³ç³»]
    E --> F[ç¬¬å…­æ­¥: éªŒè¯æ¨¡å‹å®Œæ•´æ€§]
    F --> G[ç¬¬ä¸ƒæ­¥: ä¼˜åŒ–å¸ƒå±€å±•ç¤º]
```

**è¯¦ç»†æ­¥éª¤è¯´æ˜ï¼š**

1. **è¯†åˆ«å‚ä¸è€…**
   - åˆ†æä¸šåŠ¡åœºæ™¯ï¼Œè¯†åˆ«æ‰€æœ‰ä¸ç³»ç»Ÿäº¤äº’çš„è§’è‰²
   - åŒºåˆ†ä¸šåŠ¡ä¸»è§’å’Œç³»ç»Ÿå‚ä¸è€…

2. **è¯†åˆ«èšåˆæ ¹**
   - ç¡®å®šä¸šåŠ¡è¾¹ç•Œï¼Œè¯†åˆ«èšåˆæ ¹
   - ç¡®ä¿èšåˆæ ¹å…·æœ‰å…¨å±€æ ‡è¯†

3. **è¯†åˆ«æ ¸å¿ƒå®ä½“**
   - å›´ç»•èšåˆæ ¹è¯†åˆ«ç›¸å…³å®ä½“
   - ç¡®å®šå®ä½“é—´çš„æ ¸å¿ƒå…³ç³»

4. **è¯†åˆ«çŠ¶æ€æ¨¡å¼**
   - åˆ†æä¸šåŠ¡å¯¹è±¡çš„çŠ¶æ€å˜åŒ–
   - è¯†åˆ«é€‚ç”¨çš„çŠ¶æ€æ¨¡å¼ç±»å‹

5. **å»ºç«‹å…³è”å…³ç³»**
   - å»ºç«‹å‚ä¸è€…ä¸é¢†åŸŸç±»çš„å…³ç³»
   - å»ºç«‹é¢†åŸŸç±»ä¹‹é—´çš„å…³ç³»
   - å»ºç«‹çŠ¶æ€æ¨¡å¼çš„å…³ç³»

## 6.7.3 æ¨¡å‹å…ƒç´ è¯†åˆ«è¡¨

| æ­¥éª¤       | å…ƒç´ ç±»å‹             | è¯†åˆ«åŸåˆ™                                     | è¯†åˆ«ç»“æœ                                                     |
| ---------- | -------------------- | -------------------------------------------- | ------------------------------------------------------------ |
| **ç¬¬ä¸€æ­¥** | **ä¸šåŠ¡å‚ä¸è€…**       | ä»£è¡¨å¤–éƒ¨ä¸šåŠ¡åˆ©ç›Šç›¸å…³è€…ï¼Œæ˜¯ä¸šåŠ¡æµç¨‹çš„å‘èµ·è€…   | `Customer`                                                   |
| **ç¬¬ä¸€æ­¥** | **ç³»ç»Ÿå‚ä¸è€…**       | ä»£è¡¨å†…éƒ¨è§’è‰²æˆ–å¤–éƒ¨ç³»ç»Ÿï¼Œåœ¨æµç¨‹ä¸­æ‰§è¡Œå…·ä½“ä»»åŠ¡ | `OrderManager`, `WarehouseOperator`, `PaymentGateway`, `LogisticsSystem` |
| **ç¬¬äºŒæ­¥** | **èšåˆæ ¹**           | å…·æœ‰å…¨å±€æ ‡è¯†ï¼Œç»´æŠ¤ä¸šåŠ¡å®Œæ•´æ€§è¾¹ç•Œ             | `Order`, `Product`                                           |
| **ç¬¬ä¸‰æ­¥** | **å®ä½“**             | å…·æœ‰å”¯ä¸€æ ‡è¯†çš„ä¸šåŠ¡å¯¹è±¡                       | `OrderItem`, `Payment`, `ShoppingCart`, `Inventory`          |
| **ç¬¬å››æ­¥** | **ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æ¨¡å¼** | ä¸šåŠ¡å¯¹è±¡æœ‰æ˜ç¡®çš„é˜¶æ®µé¡ºåº                     | `OrderLifecycleState` åŠå…¶å­çŠ¶æ€                             |
| **ç¬¬å››æ­¥** | **è¡Œä¸ºçŠ¶æ€æ¨¡å¼**     | å¯¹è±¡è¡Œä¸ºéšçŠ¶æ€æ˜¾è‘—å˜åŒ–                       | `PaymentBehaviorState` åŠå…¶å­çŠ¶æ€                            |
| **ç¬¬å››æ­¥** | **ç»“æ„çŠ¶æ€æ¨¡å¼**     | çŠ¶æ€å½±å“å¯¹è±¡å†…éƒ¨ç»“æ„ç»„æˆ                     | `InventoryStructuralState` åŠå…¶å­çŠ¶æ€                        |
| **ç¬¬äº”æ­¥** | **ç»„åˆå…³ç³»**         | æ•´ä½“ä¸éƒ¨åˆ†çš„å¼ºæ‰€æœ‰æƒå…³ç³»                     | `Customer` â†’ `Order`, `Order` â†’ `OrderItem`                  |
| **ç¬¬äº”æ­¥** | **å…³è”å…³ç³»**         | å¯¹è±¡é—´çš„å¼±å¼•ç”¨å…³ç³»                           | `OrderItem` â†’ `Product`, `Order` â†’ `Payment`                 |
| **ç¬¬äº”æ­¥** | **æ³›åŒ–å…³ç³»**         | çˆ¶å­ç±»çš„ç»§æ‰¿å…³ç³»                             | çŠ¶æ€ç±»ä¹‹é—´çš„ç»§æ‰¿å…³ç³»                                         |
| **ç¬¬äº”æ­¥** | **ä¾èµ–å…³ç³»**         | å‚ä¸è€…ä¸é¢†åŸŸç±»çš„äº¤äº’å…³ç³»                     | å‚ä¸è€…ä¸é¢†åŸŸç±»ä¹‹é—´çš„äº¤äº’                                     |

é€šè¿‡è¿™ä¸ªç³»ç»ŸåŒ–çš„æ–¹æ³•ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„è®¢å•ç³»ç»Ÿé¢†åŸŸæ¨¡å‹æ¦‚è§ˆï¼Œæ¸…æ™°åœ°å±•ç¤ºäº†å‚ä¸è€…ã€é¢†åŸŸç±»å’ŒçŠ¶æ€æ¨¡å¼ä¹‹é—´çš„å…³ç³»ï¼Œä¸ºåç»­çš„è¯¦ç»†è®¾è®¡å’Œå®ç°æä¾›äº†åšå®çš„åŸºç¡€ã€‚