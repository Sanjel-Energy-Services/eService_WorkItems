## 1. 程序请求提交与分配流程

```mermaid
sequenceDiagram
    participant S as 销售/调度
    participant FS as PRM应用
    participant EM as 工程经理
    participant E as 工程师
    
    S->>FS: 提交程序请求(邮件/表单)
    FS->>FS: 生成唯一程序ID
    FS->>FS: 自动分类和优先级排序
    FS->>S: 发送请求接收确认
    alt 公司有映射工程师
        FS->>E: 自动分配给对应工程师
        FS->>E: 发送邮件+应用内通知
    else 公司无映射工程师
        FS->>EM: 分配给工程经理
        EM->>E: 手动分配请求
        FS->>E: 发送分配通知
    end
    E->>FS: 确认接收请求
    FS->>FS: 更新状态为"Received/Assigned"
    FS->>S: 推送进度更新（已分配）
```

## 2. 程序审查与批准流程

```mermaid
sequenceDiagram
    participant E as 工程师
    participant FS as PRM应用
    participant R as 审查人员
    participant M as 经理
    participant D as 总监/副总裁
    participant S as 销售/调度
    participant O as 运营团队
    
    E->>FS: 完成程序草稿并提交审查
    FS->>R: 发送审查通知
    FS->>FS: 根据矩阵颜色确定审批路径
    
    alt 绿色矩阵
        FS->>R: 通知同级工程师审查
        R->>FS: 审查通过/拒绝+评论
    else 黄色矩阵
        FS->>M: 通知经理/主管审查
        M->>FS: 审查通过/拒绝+评论
    else 红色矩阵
        FS->>M: 通知经理批准
        M->>FS: 批准/拒绝+评论
    else 黑色矩阵
        FS->>M: 通知经理审查
        M->>FS: 审查通过
        FS->>D: 通知总监/副总裁最终批准
        D->>FS: 最终批准/拒绝
    end
    
    alt 审批通过
        FS->>E: 通知审批结果
        FS->>FS: 更新状态为"已批准"
        FS->>S: 通知销售/调度审批完成（提供程序文档链接/SharePoint外链）
        FS->>O: 通知运营团队可下载（提供程序文档链接/SharePoint外链）
    else 审批拒绝
        FS->>E: 退回修改并附评论
        E->>FS: 重新提交修订版本
    end
```

## 3. 多作业类型审批流程

```mermaid
sequenceDiagram
    participant E as 工程师
    participant FS as PRM应用
    participant A1 as 审批人员1
    participant A2 as 审批人员2
    participant M as 经理
    
    E->>FS: 提交包含多个作业类型的程序
    FS->>FS: 分析各作业类型的矩阵颜色
    FS->>相关审批者: 发送并行审批通知（按作业类型）
    
    par 作业类型A(绿色)
        FS->>A1: 通知同级审查
        A1->>FS: 审查结果A
    and 作业类型B(黄色)
        FS->>M: 通知经理审查
        M->>FS: 审查结果B
    and 作业类型C(红色)
        FS->>M: 通知经理批准
        M->>FS: 批准结果C
    end
    
    FS->>FS: 汇总所有审批结果
    alt 全部通过
        FS->>E: 通知完全批准
        FS->>FS: 标记程序为"已批准"
        FS->>S: 通知销售/调度可访问最终程序
        FS->>O: 通知运营团队可下载
    else 部分拒绝
        FS->>E: 通知部分拒绝详情
        E->>FS: 重新提交拒绝部分
    end
```

## 4. 搜索与报告生成流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant FS as PRM应用
    participant DB as 数据库
    
    U->>FS: 输入搜索条件(客户/日期/矩阵颜色等)
    FS->>DB: 执行搜索查询
    DB->>FS: 返回搜索结果
    FS->>U: 显示搜索结果(<3秒响应)
    
    U->>FS: 请求生成分析报告
    FS->>DB: 聚合数据(周转时间/分布等)
    DB->>FS: 返回聚合数据
    FS->>FS: 生成可视化报告
    FS->>U: 显示报告图表和指标
```

这些序列图涵盖了文档中描述的主要业务流程，包括：
- 请求提交和自动分配
- 基于复杂度矩阵的多级审批
- 多作业类型的并行审批
- 全生命周期状态跟踪
- 搜索和报告功能

## 6. 生命周期状态一致性补充

为与FRD定义的状态集保持一致，系统用例涉及的显式或隐式状态如下：

| FRD状态 | 用例中体现的动作/备注 | 说明 |
|---------|------------------------|------|
| Open | 提交程序请求 | 请求首次进入系统 |
| Received | 请求已接收 (提示) | 系统记录并进入接收阶段 |
| Unacknowledged | 发送分配通知 | 已指派但工程师未确认（隐含） |
| Acknowledged | 工程师确认接收 | 工程师主动确认分配 |
| Pending | 等待开始/分配细化 | 无明确操作时的过渡（隐含） |
| In Progress | 草稿进行中 | 工程师起草程序 |
| Sent for Review | 提交审查 | 触发评审通知 |
| Awaiting Review | 审查通知已发送 | 等待评审者处理 |
| Reviewed | 审查通过/拒绝 | 评审结束并产生结果 |
| Sent for Approval | (黄色/红色/黑色路径触发审批) | 已进入审批通知阶段 |
| Awaiting Approval | 经理/总监审批等待 | 等待最终决策输入 |
| Approved | 审批通过 | 程序被批准 |
| Sent to Sales / Awaiting Pricing | 通知销售可访问最终程序 | 销售/定价处理前置状态 |
| Completed | 上传最终文档并归档 | 生命周期闭合 |

> 注：用例文本中未显式出现的辅助过渡状态（Unacknowledged, Pending, Sent for Approval 等）在序列图外通过系统自动动作存在。

## 7. 多作业类型审批 (MVP说明)

当前实现 (MVP)：当一个程序包含多个作业类型且各自矩阵颜色不同时，可由最高权限审批者一次性批准整个程序（避免多次串行等待）。

未来扩展：每个作业类型独立记录审批步骤、结果与评论；部分拒绝时仅需重新提交被拒绝作业类型，其他保持通过状态。

## 8. 优先级与SLA补充

| 优先级 | FRD定义条件 | 用例触发点 | SLA示例 (参考) |
|--------|-------------|------------|----------------|
| Urgent | 距到期 < 4 小时 | 自动分类和优先级排序 | 响应 < 15 分钟，处理加速 |
| High | 当天到期 | 自动分类 | 首次响应 < 30 分钟 |
| Medium | 2 天内到期 | 自动分类 | 正常队列 |
| Low | >2 天 | 自动分类 | 延后处理 |

## 9. 审批路径精确描述

| 矩阵颜色 | 用例动作 | 角色 | 性质 |
|----------|----------|------|------|
| Green | 通知同级审查 | 同级工程师 | 评审 (Peer Review) |
| Yellow | 通知经理/主管审查 | 经理/主管 | 评审 (Manager Review) |
| Red | 通知经理批准 | 经理 | 最终批准 |
| Black | 经理审查→总监/VP最终批准 | 经理 + 总监/VP | 串行多级最终批准 |

## 10. 分类与报告补充

分类(Classification)：Bid / Price Quote / Awarded Work；在“程序请求提交与分配流程”阶段记录，用于后续转换率与周转报告。

报告扩展指标：
- 各矩阵颜色分布
- 审批平均耗时(分层：Peer/Manager/Director)
- 重提交率 (Reject 后重新提交次数)
- 分类转换率 (Bid→Awarded Work)
