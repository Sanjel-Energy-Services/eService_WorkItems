# Program Request Management æŠ€æœ¯æ¶æ„è®¾è®¡

## ğŸ“‹ æŠ€æœ¯æ ˆæ¦‚è§ˆ

### 1.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

**å‰ç«¯æŠ€æœ¯ï¼š**
- **Blazor Server**ï¼šå¾®è½¯ç°ä»£Webæ¡†æ¶ï¼Œæ”¯æŒC#å’ŒRazorè¯­æ³•
- **Blazor WebAssembly**ï¼šå®¢æˆ·ç«¯æ¸²æŸ“ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- **Razor Components**ï¼šå¯å¤ç”¨çš„UIç»„ä»¶
- **ASP.NET Core Identity**ï¼šç”¨æˆ·è®¤è¯å’Œæˆæƒ

**åç«¯æŠ€æœ¯ï¼š**
- **ASP.NET Core 8.0**ï¼šè·¨å¹³å°Webæ¡†æ¶
- **Entity Framework Core 8.0**ï¼šORMæ¡†æ¶
- **SQL Server 2022**ï¼šä¸»æ•°æ®åº“
- **SignalR**ï¼šå®æ—¶é€šä¿¡

**å¼€å‘å·¥å…·ï¼š**
- **Visual Studio 2022 Enterprise**ï¼šä¸»è¦IDE
- **Azure DevOps**ï¼šCI/CDå’Œé¡¹ç›®ç®¡ç†
- **Git**ï¼šç‰ˆæœ¬æ§åˆ¶

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„æ¨¡å¼

é‡‡ç”¨**åˆ†å±‚æ¶æ„**ç»“åˆ**å¾®æœåŠ¡**çš„è®¾è®¡æ¨¡å¼ï¼š

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚ Frontend Layer"
        A[Blazor Server App]
        B[Blazor WebAssembly App]
    end
    
    subgraph "APIç½‘å…³å±‚ API Gateway"
        C[Ocelot API Gateway]
    end
    
    subgraph "å¾®æœåŠ¡å±‚ Microservices"
        D[ç”¨æˆ·è®¤è¯æœåŠ¡<br/>Authentication Service]
        E[ç¨‹åºè¯·æ±‚æœåŠ¡<br/>Program Request Service]
        F[å®¡æ‰¹å·¥ä½œæµæœåŠ¡<br/>Approval Workflow Service]
        G[é€šçŸ¥æœåŠ¡<br/>Notification Service]
        H[æ–‡æ¡£ç®¡ç†æœåŠ¡<br/>Document Service]
        I[æŠ¥è¡¨æœåŠ¡<br/>Reporting Service]
    end
    
    subgraph "æ•°æ®å±‚ Data Layer"
        J[SQL Server ä¸»æ•°æ®åº“]
        K[Redis ç¼“å­˜]
        L[Azure Blob Storage]
    end
    
    subgraph "å¤–éƒ¨é›†æˆ External Integration"
        M[FreshService API]
        N[é‚®ä»¶æœåŠ¡]
        O[æ–‡ä»¶å­˜å‚¨]
    end
    
    A --> C
    B --> C
    C --> D
    C --> E
    C --> F
    C --> G
    C --> H
    C --> I
    
    D --> J
    E --> J
    F --> J
    G --> J
    H --> J
    I --> J
    
    E --> K
    F --> K
    G --> K
    
    H --> L
    
    E --> M
    G --> N
    H --> O
```

### 2.2 å¾®æœåŠ¡è¯¦ç»†è®¾è®¡

#### 2.2.1 ç”¨æˆ·è®¤è¯æœåŠ¡ (Authentication Service)
**æŠ€æœ¯æ ˆï¼š** ASP.NET Core Identity + JWT
**èŒè´£ï¼š**
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æ³¨é”€
- è§’è‰²å’Œæƒé™ç®¡ç†
- JWTä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯
- å¯†ç ç­–ç•¥å’Œå®‰å…¨ç®¡ç†

**å…³é”®ç»„ä»¶ï¼š**
```csharp
// ä¸»è¦æœåŠ¡æ¥å£
public interface IAuthenticationService
{
    Task<AuthenticationResult> LoginAsync(LoginRequest request);
    Task<RegistrationResult> RegisterAsync(RegisterRequest request);
    Task<bool> ValidateTokenAsync(string token);
    Task<UserProfile> GetUserProfileAsync(string userId);
}

// è§’è‰²å®šä¹‰
public enum UserRole
{
    SalesDispatch,
    Engineer,
    EngineeringManager,
    DirectorVP,
    Approver,
    OperationsField
}
```

#### 2.2.2 ç¨‹åºè¯·æ±‚æœåŠ¡ (Program Request Service)
**æŠ€æœ¯æ ˆï¼š** ASP.NET Core Web API + Entity Framework Core
**èŒè´£ï¼š**
- ç¨‹åºè¯·æ±‚çš„CRUDæ“ä½œ
- è¯·æ±‚çŠ¶æ€ç®¡ç†
- è‡ªåŠ¨åˆ†é…é€»è¾‘
- å¤æ‚åº¦çŸ©é˜µè®¡ç®—

**æ ¸å¿ƒå®ä½“ï¼š**
```csharp
public class ProgramRequest
{
    public Guid Id { get; set; }
    public string CustomerName { get; set; }
    public RequestType RequestType { get; set; }
    public ComplexityMatrix Complexity { get; set; }
    public ProgramRequestStatus Status { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? AssignedAt { get; set; }
    public string AssignedEngineerId { get; set; }
    public List<RequestDocument> Documents { get; set; }
}

public enum ProgramRequestStatus
{
    Open,
    Received,
    Unacknowledged,
    Acknowledged,
    Pending,
    InProgress,
    SentForReview,
    AwaitingReview,
    Reviewed,
    SentForApproval,
    AwaitingApproval,
    Approved,
    SentToSales,
    Completed
}
```

#### 2.2.3 å®¡æ‰¹å·¥ä½œæµæœåŠ¡ (Approval Workflow Service)
**æŠ€æœ¯æ ˆï¼š** ASP.NET Core + çŠ¶æ€æ¨¡å¼ + å·¥ä½œæµå¼•æ“
**èŒè´£ï¼š**
- å®¡æ‰¹æµç¨‹ç®¡ç†
- å¤æ‚åº¦çŸ©é˜µè·¯ç”±
- å¤šçº§å®¡æ‰¹æ”¯æŒ
- å®¡æ‰¹å†å²è®°å½•

**å·¥ä½œæµå¼•æ“è®¾è®¡ï¼š**
```csharp
public interface IWorkflowEngine
{
    Task<WorkflowResult> StartWorkflowAsync(Guid requestId);
    Task<WorkflowResult> ProcessStepAsync(WorkflowStep step);
    Task<List<WorkflowStep>> GetPendingStepsAsync(string userId);
}

public class ComplexityMatrix
{
    public MatrixColor Color { get; set; } // Red, Yellow, Green, Black
    public int ComplexityScore { get; set; }
    public List<ApprovalLevel> ApprovalLevels { get; set; }
}

public enum MatrixColor
{
    Red,    // ç®€å•å®¡æ‰¹
    Yellow, // ä¸­ç­‰å®¡æ‰¹
    Green,  // å¤æ‚å®¡æ‰¹
    Black   // æ€»ç›‘/å‰¯æ€»è£å®¡æ‰¹
}
```

#### 2.2.4 é€šçŸ¥æœåŠ¡ (Notification Service)
**æŠ€æœ¯æ ˆï¼š** ASP.NET Core + SignalR + SendGrid
**èŒè´£ï¼š**
- å®æ—¶é€šçŸ¥æ¨é€
- é‚®ä»¶é€šçŸ¥
- é€šçŸ¥æ¨¡æ¿ç®¡ç†
- é€šçŸ¥å†å²è®°å½•

**é€šçŸ¥æ¶æ„ï¼š**
```csharp
public interface INotificationService
{
    Task SendNotificationAsync(NotificationRequest request);
    Task SendEmailAsync(EmailRequest request);
    Task<List<Notification>> GetUserNotificationsAsync(string userId);
}

public class NotificationRequest
{
    public string UserId { get; set; }
    public NotificationType Type { get; set; }
    public string Title { get; set; }
    public string Message { get; set; }
    public Dictionary<string, object> Data { get; set; }
}
```

---

## ğŸ’¾ æ•°æ®æ¶æ„è®¾è®¡

### 3.1 æ•°æ®åº“è®¾è®¡

#### 3.1.1 ä¸»è¦æ•°æ®è¡¨

**ç”¨æˆ·ç›¸å…³è¡¨ï¼š**
```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE Users (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    UserName NVARCHAR(256) NOT NULL UNIQUE,
    Email NVARCHAR(256) NOT NULL UNIQUE,
    FirstName NVARCHAR(100) NOT NULL,
    LastName NVARCHAR(100) NOT NULL,
    Role NVARCHAR(50) NOT NULL,
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 DEFAULT GETUTCDATE()
);

-- è§’è‰²è¡¨
CREATE TABLE Roles (
    Id INT PRIMARY KEY IDENTITY,
    Name NVARCHAR(50) NOT NULL UNIQUE,
    Description NVARCHAR(500),
    Permissions NVARCHAR(MAX) -- JSONæ ¼å¼å­˜å‚¨æƒé™
);

-- ç”¨æˆ·è§’è‰²æ˜ å°„è¡¨
CREATE TABLE UserRoles (
    UserId UNIQUEIDENTIFIER NOT NULL,
    RoleId INT NOT NULL,
    AssignedAt DATETIME2 DEFAULT GETUTCDATE(),
    PRIMARY KEY (UserId, RoleId),
    FOREIGN KEY (UserId) REFERENCES Users(Id),
    FOREIGN KEY (RoleId) REFERENCES Roles(Id)
);
```

**ç¨‹åºè¯·æ±‚ç›¸å…³è¡¨ï¼š**
```sql
-- ç¨‹åºè¯·æ±‚è¡¨
CREATE TABLE ProgramRequests (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    CustomerName NVARCHAR(200) NOT NULL,
    RequestType NVARCHAR(100) NOT NULL,
    ServiceLine NVARCHAR(100) NOT NULL,
    Description NVARCHAR(MAX),
    ComplexityColor NVARCHAR(20) NOT NULL,
    ComplexityScore INT NOT NULL,
    Status NVARCHAR(50) NOT NULL,
    Priority NVARCHAR(20) DEFAULT 'Medium',
    CreatedBy UNIQUEIDENTIFIER NOT NULL,
    AssignedEngineerId UNIQUEIDENTIFIER NULL,
    CreatedAt DATETIME2 DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 DEFAULT GETUTCDATE(),
    CompletedAt DATETIME2 NULL,
    FOREIGN KEY (CreatedBy) REFERENCES Users(Id),
    FOREIGN KEY (AssignedEngineerId) REFERENCES Users(Id)
);

-- è¯·æ±‚çŠ¶æ€å†å²è¡¨
CREATE TABLE RequestStatusHistory (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    RequestId UNIQUEIDENTIFIER NOT NULL,
    FromStatus NVARCHAR(50),
    ToStatus NVARCHAR(50) NOT NULL,
    ChangedBy UNIQUEIDENTIFIER NOT NULL,
    Comments NVARCHAR(500),
    ChangedAt DATETIME2 DEFAULT GETUTCDATE(),
    FOREIGN KEY (RequestId) REFERENCES ProgramRequests(Id),
    FOREIGN KEY (ChangedBy) REFERENCES Users(Id)
);

-- å®¡æ‰¹è®°å½•è¡¨
CREATE TABLE ApprovalRecords (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    RequestId UNIQUEIDENTIFIER NOT NULL,
    ApproverId UNIQUEIDENTIFIER NOT NULL,
    ApprovalLevel INT NOT NULL,
    Decision NVARCHAR(20) NOT NULL, -- Approved, Rejected, Pending
    Comments NVARCHAR(MAX),
    ApprovedAt DATETIME2 NULL,
    FOREIGN KEY (RequestId) REFERENCES ProgramRequests(Id),
    FOREIGN KEY (ApproverId) REFERENCES Users(Id)
);
```

#### 3.1.2 Entity Framework Core é…ç½®

**DbContext è®¾è®¡ï¼š**
```csharp
public class PRMDbContext : DbContext
{
    public PRMDbContext(DbContextOptions<PRMDbContext> options)
        : base(options)
    {
    }

    // ç”¨æˆ·ç›¸å…³
    public DbSet<User> Users { get; set; }
    public DbSet<Role> Roles { get; set; }
    public DbSet<UserRole> UserRoles { get; set; }

    // ç¨‹åºè¯·æ±‚ç›¸å…³
    public DbSet<ProgramRequest> ProgramRequests { get; set; }
    public DbSet<RequestStatusHistory> RequestStatusHistory { get; set; }
    public DbSet<ApprovalRecord> ApprovalRecords { get; set; }

    // æ–‡æ¡£ç›¸å…³
    public DbSet<Document> Documents { get; set; }
    public DbSet<DocumentVersion> DocumentVersions { get; set; }

    // é€šçŸ¥ç›¸å…³
    public DbSet<Notification> Notifications { get; set; }
    public DbSet<NotificationTemplate> NotificationTemplates { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // é…ç½®å®ä½“å…³ç³»
        modelBuilder.Entity<ProgramRequest>()
            .HasOne(pr => pr.CreatedByUser)
            .WithMany()
            .HasForeignKey(pr => pr.CreatedBy)
            .OnDelete(DeleteBehavior.Restrict);

        modelBuilder.Entity<ProgramRequest>()
            .HasOne(pr => pr.AssignedEngineer)
            .WithMany()
            .HasForeignKey(pr => pr.AssignedEngineerId)
            .OnDelete(DeleteBehavior.SetNull);

        // é…ç½®æšä¸¾è½¬æ¢
        modelBuilder.Entity<ProgramRequest>()
            .Property(pr => pr.Status)
            .HasConversion<string>();

        modelBuilder.Entity<ProgramRequest>()
            .Property(pr => pr.ComplexityColor)
            .HasConversion<string>();

        // é…ç½®ç´¢å¼•
        modelBuilder.Entity<ProgramRequest>()
            .HasIndex(pr => pr.Status);
            
        modelBuilder.Entity<ProgramRequest>()
            .HasIndex(pr => pr.CreatedAt);
    }
}
```

### 3.2 ç¼“å­˜ç­–ç•¥

**Redis ç¼“å­˜è®¾è®¡ï¼š**
```csharp
public interface ICacheService
{
    Task<T> GetAsync<T>(string key);
    Task SetAsync<T>(string key, T value, TimeSpan? expiry = null);
    Task RemoveAsync(string key);
    Task RemoveByPatternAsync(string pattern);
}

// ç¼“å­˜é”®å®šä¹‰
public static class CacheKeys
{
    public const string UserById = "User:ById:{0}";
    public const string UserRoles = "User:Roles:{0}";
    public const string ProgramRequestById = "ProgramRequest:ById:{0}";
    public const string PendingRequests = "ProgramRequest:Pending:{0}";
    public const string NotificationCount = "Notification:Count:{0}";
}
```

---

## ğŸ”Œ API è®¾è®¡è§„èŒƒ

### 4.1 RESTful API è®¾è®¡åŸåˆ™

**URL å‘½åè§„èŒƒï¼š**
- ä½¿ç”¨å¤æ•°åè¯ï¼š`/api/programrequests`
- ä½¿ç”¨å°å†™å­—æ¯å’Œè¿å­—ç¬¦ï¼š`/api/users/{userId}/notifications`
- èµ„æºåµŒå¥—ï¼š`/api/programrequests/{id}/documents`

**HTTP æ–¹æ³•ä½¿ç”¨ï¼š**
- `GET`ï¼šè·å–èµ„æº
- `POST`ï¼šåˆ›å»ºèµ„æº
- `PUT`ï¼šå®Œæ•´æ›´æ–°èµ„æº
- `PATCH`ï¼šéƒ¨åˆ†æ›´æ–°èµ„æº
- `DELETE`ï¼šåˆ é™¤èµ„æº

### 4.2 API æ§åˆ¶å™¨è®¾è®¡

**ç¨‹åºè¯·æ±‚ APIï¼š**
```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize]
public class ProgramRequestsController : ControllerBase
{
    private readonly IProgramRequestService _service;

    [HttpGet]
    public async Task<ActionResult<PagedResult<ProgramRequestDto>>> GetProgramRequests(
        [FromQuery] ProgramRequestParameters parameters)
    {
        var result = await _service.GetProgramRequestsAsync(parameters);
        return Ok(result);
    }

    [HttpGet("{id}")]
    public async Task<ActionResult<ProgramRequestDetailDto>> GetProgramRequest(Guid id)
    {
        var result = await _service.GetProgramRequestAsync(id);
        return Ok(result);
    }

    [HttpPost]
    public async Task<ActionResult<ProgramRequestDto>> CreateProgramRequest(
        [FromBody] CreateProgramRequestRequest request)
    {
        var result = await _service.CreateProgramRequestAsync(request);
        return CreatedAtAction(nameof(GetProgramRequest), new { id = result.Id }, result);
    }

    [HttpPut("{id}")]
    public async Task<ActionResult<ProgramRequestDto>> UpdateProgramRequest(
        Guid id, [FromBody] UpdateProgramRequestRequest request)
    {
        var result = await _service.UpdateProgramRequestAsync(id, request);
        return Ok(result);
    }

    [HttpPost("{id}/submit")]
    public async Task<ActionResult> SubmitProgramRequest(Guid id)
    {
        await _service.SubmitProgramRequestAsync(id);
        return NoContent();
    }

    [HttpPost("{id}/assign")]
    public async Task<ActionResult> AssignProgramRequest(
        Guid id, [FromBody] AssignRequest request)
    {
        await _service.AssignProgramRequestAsync(id, request.EngineerId);
        return NoContent();
    }
}
```

### 4.3 DTO è®¾è®¡

**æ•°æ®ä¼ è¾“å¯¹è±¡å®šä¹‰ï¼š**
```csharp
public class ProgramRequestDto
{
    public Guid Id { get; set; }
    public string CustomerName { get; set; }
    public string RequestType { get; set; }
    public string Status { get; set; }
    public string ComplexityColor { get; set; }
    public DateTime CreatedAt { get; set; }
    public string AssignedEngineerName { get; set; }
}

public class CreateProgramRequestRequest
{
    [Required]
    [StringLength(200)]
    public string CustomerName { get; set; }

    [Required]
    public string RequestType { get; set; }

    [Required]
    public string ServiceLine { get; set; }

    [StringLength(2000)]
    public string Description { get; set; }

    public List<IFormFile> Attachments { get; set; }
}

public class ProgramRequestParameters
{
    public int PageNumber { get; set; } = 1;
    public int PageSize { get; set; } = 20;
    public string Status { get; set; }
    public string CustomerName { get; set; }
    public DateTime? FromDate { get; set; }
    public DateTime? ToDate { get; set; }
}
```

---

## ğŸ›¡ï¸ å®‰å…¨æ¶æ„è®¾è®¡

### 5.1 è®¤è¯ä¸æˆæƒ

**JWT Token é…ç½®ï¼š**
```csharp
public class JwtConfiguration
{
    public string SecretKey { get; set; }
    public string Issuer { get; set; }
    public string Audience { get; set; }
    public int ExpirationMinutes { get; set; } = 60;
}

// JWT æœåŠ¡
public class JwtTokenService : IJwtTokenService
{
    private readonly JwtConfiguration _config;

    public string GenerateToken(User user, IList<string> roles)
    {
        var claims = new List<Claim>
        {
            new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
            new Claim(ClaimTypes.Name, user.UserName),
            new Claim(ClaimTypes.Email, user.Email)
        };

        foreach (var role in roles)
        {
            claims.Add(new Claim(ClaimTypes.Role, role));
        }

        var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_config.SecretKey));
        var credentials = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

        var token = new JwtSecurityToken(
            issuer: _config.Issuer,
            audience: _config.Audience,
            claims: claims,
            expires: DateTime.Now.AddMinutes(_config.ExpirationMinutes),
            signingCredentials: credentials
        );

        return new JwtSecurityTokenHandler().WriteToken(token);
    }
}
```

### 5.2 æƒé™æ§åˆ¶

**åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC)ï¼š**
```csharp
public class PermissionRequirement : IAuthorizationRequirement
{
    public string Permission { get; }

    public PermissionRequirement(string permission)
    {
        Permission = permission;
    }
}

public class PermissionAuthorizationHandler : AuthorizationHandler<PermissionRequirement>
{
    protected override Task HandleRequirementAsync(
        AuthorizationHandlerContext context,
        PermissionRequirement requirement)
    {
        var permissions = context.User.Claims
            .Where(c => c.Type == "Permission")
            .Select(c => c.Value)
            .ToList();

        if (permissions.Contains(requirement.Permission))
        {
            context.Succeed(requirement);
        }

        return Task.CompletedTask;
    }
}

// æƒé™å®šä¹‰
public static class Permissions
{
    public const string ViewRequests = "requests:view";
    public const string CreateRequest = "requests:create";
    public const string AssignRequest = "requests:assign";
    public const string ApproveRequest = "requests:approve";
    public const string ViewReports = "reports:view";
}
```

---

## ğŸ”„ é›†æˆæ¶æ„è®¾è®¡

### 6.1 FreshService é›†æˆ

**é›†æˆæœåŠ¡è®¾è®¡ï¼š**
```csharp
public interface IFreshServiceIntegration
{
    Task<Ticket> CreateTicketAsync(ProgramRequest request);
    Task<Ticket> UpdateTicketAsync(Guid ticketId, UpdateTicketRequest request);
    Task<Ticket> GetTicketAsync(Guid ticketId);
    Task<List<Ticket>> GetTicketsByRequesterAsync(string email);
}

public class FreshServiceService : IFreshServiceIntegration
{
    private readonly HttpClient _httpClient;
    private readonly FreshServiceConfiguration _config;

    public async Task<Ticket> CreateTicketAsync(ProgramRequest request)
    {
        var ticketRequest = new CreateTicketRequest
        {
            Subject = $"Program Request - {request.CustomerName}",
            Description = request.Description,
            Requester = new RequesterInfo { Email = request.RequesterEmail },
            Priority = MapPriority(request.Priority),
            Category = "Program Request",
            CustomFields = new
            {
                program_request_id = request.Id.ToString(),
                complexity_color = request.ComplexityColor,
                service_line = request.ServiceLine
            }
        };

        var response = await _httpClient.PostAsJsonAsync("/api/v2/tickets", ticketRequest);
        response.EnsureSuccessStatusCode();

        return await response.Content.ReadFromJsonAsync<Ticket>();
    }
}
```

### 6.2 é‚®ä»¶æœåŠ¡é›†æˆ

**SendGrid é›†æˆï¼š**
```csharp
public interface IEmailService
{
    Task SendEmailAsync(EmailMessage message);
    Task SendTemplateEmailAsync(TemplateEmailMessage message);
}

public class SendGridEmailService : IEmailService
{
    private readonly ISendGridClient _client;

    public async Task SendTemplateEmailAsync(TemplateEmailMessage message)
    {
        var msg = new SendGridMessage
        {
            From = new EmailAddress(message.FromEmail, message.FromName),
            Subject = message.Subject,
            TemplateId = message.TemplateId
        };

        msg.AddTo(message.ToEmail, message.ToName);
        
        foreach (var templateData in message.TemplateData)
        {
            msg.SetTemplateData(templateData);
        }

        var response = await _client.SendEmailAsync(msg);
        response.EnsureSuccess();
    }
}
```

---

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—æ¶æ„

### 7.1 åº”ç”¨ç›‘æ§

**Application Insights é›†æˆï¼š**
```csharp
public class TelemetryService : ITelemetryService
{
    private readonly TelemetryClient _telemetryClient;

    public void TrackEvent(string eventName, IDictionary<string, string> properties = null)
    {
        _telemetryClient.TrackEvent(eventName, properties);
    }

    public void TrackException(Exception exception, IDictionary<string, string> properties = null)
    {
        _telemetryClient.TrackException(exception, properties);
    }

    public void TrackMetric(string metricName, double value, IDictionary<string, string> properties = null)
    {
        var metric = new MetricTelemetry
        {
            Name = metricName,
            Sum = value
        };

        if (properties != null)
        {
            foreach (var property in properties)
            {
                metric.Properties.Add(property);
            }
        }

        _telemetryClient.TrackMetric(metric);
    }
}
```

### 7.2 æ—¥å¿—æ¶æ„

**Serilog é…ç½®ï¼š**
```csharp
public class Program
{
    public static void Main(string[] args)
    {
        Log.Logger = new LoggerConfiguration()
            .MinimumLevel.Information()
            .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
            .Enrich.FromLogContext()
            .Enrich.WithProperty("Application", "PRM.API")
            .WriteTo.Console()
            .WriteTo.File(
                path: "logs/prm-.log",
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 30,
                outputTemplate: "[{Timestamp:yyyy-MM-dd HH:mm:ss} {Level:u3}] {Application} {RequestId} {Message:lj}{NewLine}{Exception}")
            .WriteTo.Seq("http://localhost:5341")
            .CreateLogger();

        CreateHostBuilder(args).Build().Run();
    }
}
```

---

## ğŸš€ éƒ¨ç½²æ¶æ„è®¾è®¡

### 8.1 Azure éƒ¨ç½²æ¶æ„

**Azure èµ„æºè§„åˆ’ï¼š**
```yaml
# Azure èµ„æºç»„
resource_group: prm-prod-rg

# åº”ç”¨æœåŠ¡
app_service_plan:
  name: prm-prod-asp
  tier: Standard
  size: S2

# åº”ç”¨æœåŠ¡
app_services:
  - name: prm-api
    runtime: DOTNETCORE|8.0
  - name: prm-auth
    runtime: DOTNETCORE|8.0
  - name: prm-workflow
    runtime: DOTNETCORE|8.0

# æ•°æ®åº“
sql_database:
  server: prm-prod-sql.database.windows.net
  database: PRM_Prod
  tier: Standard
  size: S2

# ç¼“å­˜
redis_cache:
  name: prm-prod-redis
  tier: Standard
  size: C1

# å­˜å‚¨
storage_account:
  name: prmprodstorage
  tier: Standard
  replication: LRS
```

### 8.2 Docker å®¹å™¨åŒ–

**Dockerfile ç¤ºä¾‹ï¼š**
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 80
EXPOSE 443

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["PRM.API/PRM.API.csproj", "PRM.API/"]
COPY ["PRM.Core/PRM.Core.csproj", "PRM.Core/"]
COPY ["PRM.Infrastructure/PRM.Infrastructure.csproj", "PRM.Infrastructure/"]
RUN dotnet restore "PRM.API/PRM.API.csproj"
COPY . .
WORKDIR "/src/PRM.API"
RUN dotnet build "PRM.API.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "PRM.API.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "PRM.API.dll"]
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 9.1 æ•°æ®åº“ä¼˜åŒ–

**ç´¢å¼•ç­–ç•¥ï¼š**
```sql
-- ç¨‹åºè¯·æ±‚è¡¨ç´¢å¼•
CREATE INDEX IX_ProgramRequests_Status_CreatedAt 
ON ProgramRequests(Status, CreatedAt DESC);

CREATE INDEX IX_ProgramRequests_AssignedEngineerId_Status 
ON ProgramRequests(AssignedEngineerId, Status);

CREATE INDEX IX_ProgramRequests_CustomerName_Status 
ON ProgramRequests(CustomerName, Status);

-- å®¡æ‰¹è®°å½•è¡¨ç´¢å¼•
CREATE INDEX IX_ApprovalRecords_RequestId_ApprovalLevel 
ON ApprovalRecords(RequestId, ApprovalLevel);

CREATE INDEX IX_ApprovalRecords_ApproverId_Decision 
ON ApprovalRecords(ApproverId, Decision);
```

### 9.2 ç¼“å­˜ç­–ç•¥

**å¤šçº§ç¼“å­˜è®¾è®¡ï¼š**
```csharp
public class CachedProgramRequestService : IProgramRequestService
{
    private readonly IProgramRequestService _service;
    private readonly ICacheService _cache;
    private readonly IMemoryCache _memoryCache;

    public async Task<ProgramRequestDto> GetProgramRequestAsync(Guid id)
    {
        var cacheKey = string.Format(CacheKeys.ProgramRequestById, id);
        
        // å…ˆä»å†…å­˜ç¼“å­˜è·å–
        if (_memoryCache.TryGetValue(cacheKey, out ProgramRequestDto cachedResult))
        {
            return cachedResult;
        }

        // å†ä»Redisç¼“å­˜è·å–
        var redisResult = await _cache.GetAsync<ProgramRequestDto>(cacheKey);
        if (redisResult != null)
        {
            _memoryCache.Set(cacheKey, redisResult, TimeSpan.FromMinutes(5));
            return redisResult;
        }

        // æœ€åä»æ•°æ®åº“è·å–
        var result = await _service.GetProgramRequestAsync(id);
        
        // è®¾ç½®ç¼“å­˜
        await _cache.SetAsync(cacheKey, result, TimeSpan.FromHours(1));
        _memoryCache.Set(cacheKey, result, TimeSpan.FromMinutes(5));

        return result;
    }
}
```

---

## ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®

### 10.1 å¼€å‘å·¥å…·é…ç½®

**Visual Studio é…ç½®ï¼š**
```json
{
  "profiles": {
    "PRM.API": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "applicationUrl": "https://localhost:5001;http://localhost:5000",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development",
        "ASPNETCORE_URLS": "https://localhost:5001;http://localhost:5000"
      }
    },
    "Docker": {
      "commandName": "Docker",
      "launchBrowser": true,
      "DockerfileRunArguments": "--rm -e ASPNETCORE_ENVIRONMENT=Development"
    }
  }
}
```

### 10.2 å¼€å‘æ•°æ®åº“é…ç½®

**LocalDB é…ç½®ï¼š**
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=PRM_Dev;Trusted_Connection=true;MultipleActiveResultSets=true",
    "Redis": "localhost:6379",
    "FreshService": "https://yourcompany.freshservice.com/api/v2"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

---

## ğŸ“‹ æŠ€æœ¯å†³ç­–è®°å½• (ADR)

### ADR-001: é€‰æ‹© .NET æŠ€æœ¯æ ˆ
**çŠ¶æ€ï¼š** å·²æ¥å—  
**æ—¥æœŸï¼š** 2024-12-01  
**å†³ç­–ï¼š** é‡‡ç”¨å¾®è½¯ .NET 8.0 æŠ€æœ¯æ ˆ  
**ç†ç”±ï¼š** 
- ä¼ä¸šçº§åº”ç”¨ç¨³å®šæ€§å’Œæ€§èƒ½
- ä¸ç°æœ‰å¾®è½¯ç”Ÿæ€ç³»ç»Ÿå…¼å®¹
- ä¸°å¯Œçš„å¼€å‘å·¥å…·å’Œç¤¾åŒºæ”¯æŒ
- å¼ºç±»å‹è¯­è¨€æä¾›æ›´å¥½çš„ä»£ç è´¨é‡

### ADR-002: é€‰æ‹© Blazor ä½œä¸ºå‰ç«¯æ¡†æ¶
**çŠ¶æ€ï¼š** å·²æ¥å—  
**æ—¥æœŸï¼š** 2024-12-01  
**å†³ç­–ï¼š** é‡‡ç”¨ Blazor Server + Blazor WebAssembly æ··åˆæ¶æ„  
**ç†ç”±ï¼š**
- ç»Ÿä¸€çš„ C# æŠ€æœ¯æ ˆï¼Œé™ä½å­¦ä¹ æˆæœ¬
- æœåŠ¡å™¨ç«¯æ¸²æŸ“æä¾›æ›´å¥½çš„SEO
- WebAssembly æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- ä¸ .NET åç«¯æ— ç¼é›†æˆ

### ADR-003: é€‰æ‹© SQL Server ä½œä¸ºä¸»æ•°æ®åº“
**çŠ¶æ€ï¼š** å·²æ¥å—  
**æ—¥æœŸï¼š** 2024-12-01  
**å†³ç­–ï¼š** é‡‡ç”¨ SQL Server 2022 ä½œä¸ºä¸»æ•°æ®åº“  
**ç†ç”±ï¼š**
- ä¸ .NET ç”Ÿæ€ç³»ç»Ÿçš„æœ€ä½³é›†æˆ
- ä¼ä¸šçº§æ•°æ®å®‰å…¨æ€§å’Œæ€§èƒ½
- ä¸°å¯Œçš„å·¥å…·æ”¯æŒï¼ˆSSMS, Azure Data Studioï¼‰
- æˆç†Ÿçš„é«˜å¯ç”¨æ€§å’Œå¤‡ä»½æ–¹æ¡ˆ

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**åˆ›å»ºæ—¥æœŸï¼š** 2024-12-01  
**æœ€åæ›´æ–°ï¼š** 2024-12-01  
**æ¶æ„å¸ˆï¼š** [æ¶æ„å¸ˆå§“å]  
**å®¡æ ¸äººï¼š** [æŠ€æœ¯è´Ÿè´£äººå§“å]